<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NRA Member Communications Portal - AI Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Include Froala Editor style -->
    <link href="/public/froala/css/froala_editor.pkgd.min.css" rel="stylesheet" />

    <!-- Include Froala Editor script -->
    <script src="/public/froala/js/froala_editor.pkgd.min.js"></script>
    <style>
        /* Include all the original styles plus new ones for AI features */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f2f1;
            color: #323130;
            overflow: hidden;
        }

        /* Priority indicators */
        .priority-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .priority-high {
            background: #d13438;
        }

        .priority-medium {
            background: #ffb900;
        }

        .priority-low {
            background: #10c510;
        }

        /* Priority score badge */
        .priority-score {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .priority-score.high {
            background: #fde7e9;
            color: #a4262c;
        }

        .priority-score.medium {
            background: #fff4ce;
            color: #8a6100;
        }

        .priority-score.low {
            background: #e7f6e7;
            color: #0b7209;
        }

        /* AI Insights Panel */
        .ai-insights-panel {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .ai-insights-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .ai-insights-header i {
            font-size: 24px;
            color: #5c2d91;
            margin-right: 12px;
        }

        .ai-insights-header h3 {
            font-size: 20px;
            color: #323130;
        }

        /* Action items list */
        .action-items-list {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .action-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border-bottom: 1px solid #edebe9;
            transition: background 0.2s;
        }

        .action-item:hover {
            background: #faf9f8;
        }

        .action-item:last-child {
            border-bottom: none;
        }

        .action-checkbox {
            margin-right: 12px;
            margin-top: 2px;
        }

        .action-content {
            flex: 1;
        }

        .action-text {
            font-size: 14px;
            color: #323130;
            margin-bottom: 4px;
        }

        .action-meta {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #605e5c;
        }

        .action-deadline {
            display: inline-flex;
            align-items: center;
            margin-left: 16px;
        }

        .action-deadline i {
            margin-right: 4px;
            font-size: 11px;
        }

        /* Sender insights */
        .sender-insights {
            background: #faf9f8;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .sender-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .sender-stat-label {
            color: #605e5c;
            font-size: 13px;
        }

        .sender-stat-value {
            font-weight: 600;
            color: #323130;
        }

        /* All original styles from the previous file... */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f2f1;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .header {
            background: white;
            border-bottom: 1px solid #edebe9;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            margin-left: 12px;
            flex: 1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #605e5c;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10c510;
            border-radius: 50%;
            margin-right: 6px;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 48px);
        }

        .sidebar {
            width: 220px;
            background: #faf9f8;
            border-right: 1px solid #edebe9;
            /* padding: 24px 0; */
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 24px;
            color: #605e5c;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
            position: relative;
        }

        .nav-item:hover {
            background: #f3f2f1;
            color: #323130;
        }

        .nav-item.active {
            background: #e1dfdd;
            color: #323130;
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #0078d4;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }

        .nav-count {
            margin-left: auto;
            background: #0078d4;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .content {
            flex: 1;
            overflow: hidden;
            background: #f3f2f1;
        }

        .view {
            height: 100%;
            overflow-y: auto;
        }

        /* NEW: Email view container for better structure */
        .email-view-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* UPDATED: Global filter bar with multi-row support */
        .global-filter-bar {
            background: white;
            border-bottom: 1px solid #edebe9;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }

        /* Collapsible Filter Bar Styles - Understated NRA Style */
        .filter-bar {
            background: #2c2c2c;
            padding: 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            user-select: none;
            border: 1px solid #3c3c3c;
        }

        .filter-bar:hover {
            background: #333333;
            border-color: #404040;
        }

        .filter-bar.collapsed {
            padding: 8px 12px;
        }

        .filter-bar.collapsed:hover {
            background: #333333;
            border-color: #404040;
        }

        .filter-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            padding: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #e0e0e0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
            pointer-events: none;
            font-weight: 500;
        }

        .filter-toggle i {
            transition: transform 0.3s ease;
            font-size: 14px;
        }

        .filter-bar.collapsed .filter-toggle i {
            transform: rotate(180deg);
        }

        .filter-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .filter-bar.collapsed .filter-content {
            height: 0;
            opacity: 0;
            margin: 0;
        }

        /* Prevent filter chips from being clickable when collapsed */
        .filter-bar.collapsed .filter-chip {
            pointer-events: none;
        }

        /* Active filter summary - shown when collapsed */
        .active-filters-summary {
            display: none;
            align-items: center;
            gap: 8px;
            margin-right: 30px;
            flex-wrap: wrap;
        }

        .filter-bar.collapsed .active-filters-summary {
            display: flex;
        }

        /* Active filter pill - Understated Style */
        .active-filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #0078d4;
            color: white;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            pointer-events: auto;
        }

        .active-filter-pill .remove-filter {
            cursor: pointer;
            margin-left: 4px;
            font-size: 14px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .active-filter-pill .remove-filter:hover {
            opacity: 1;
        }

        .filter-summary-text {
            color: #d0d0d0;
            font-size: 12px;
            font-weight: 500;
        }

        /* Clear all button in summary - Understated Style */
        .summary-clear-btn {
            margin-left: 8px;
            padding: 4px 10px;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s;
            color: #d0d0d0;
            font-weight: 500;
        }

        .summary-clear-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            color: #ffffff;
        }

        /* NEW: Filter row for organizing filters by category */
        .filter-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            padding-bottom: 10px;
            border-bottom: 1px solid #edebe9;
        }

        .filter-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        /* UPDATED: Filter category labels - Understated Style */
        .filter-category-label {
            font-weight: 600;
            color: #d0d0d0;
            font-size: 11px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-right: 8px;
            min-width: 85px;
        }

        /* UPDATED: Filter chip styling - Understated Style */
        .filter-chip {
            display: inline-block;
            padding: 5px 12px;
            background: #ffffff;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 12px;
            color: #333333;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 500;
        }

        .filter-chip:hover {
            background: #f8f8f8;
            border-color: #666666;
            color: #000000;
        }

        .filter-chip.active {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .filter-chip.active:hover {
            background: #0056b3;
            border-color: #0056b3;
        }

        /* Responsive design for filter rows */
        @media (max-width: 768px) {
            .filter-category-label {
                min-width: 100%;
                margin-bottom: 5px;
            }

            .filter-row {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Adjust the first filter row when expanded */
        .filter-bar:not(.collapsed) .filter-row:first-child {
            padding-right: 100px;
        }

        /* Preset filters section - Understated Style */
        .preset-filters {
            padding: 12px 24px;
            background: #e8e8e8;
            border-bottom: 1px solid #d0d0d0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preset-label {
            font-size: 12px;
            color: #4a4a4a;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preset-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: #ffffff;
            border: 1px solid #b8b8b8;
            border-radius: 4px;
            font-size: 12px;
            color: #2c2c2c;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: 500;
        }

        .preset-btn:hover {
            background: #f5f5f5;
            border-color: #40a6ff;
            color: #2c2c2c;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .preset-btn.active {
            background: #2698fb;
            color: white;
            border-color: #40a6ff;
        }

        .preset-btn.active:hover {
            background: #2196f3;
            border-color: #2196f3;
        }

        .preset-btn i {
            font-size: 11px;
        }

        /* Divider between presets - Understated Style */
        .preset-divider {
            width: 1px;
            height: 20px;
            background: #b8b8b8;
            margin: 0 4px;
        }

        /* Email content area below filter bar */
        .email-content-area {
            flex: 1;
            display: flex;
        }

        .email-list-panel {
            width: 350px;
            background: white;
            border-right: 1px solid #edebe9;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .list-header {
            padding: 16px;
            border-bottom: 1px solid #edebe9;
        }

        .search-box {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #edebe9;
            border-radius: 4px;
            font-size: 14px;
        }

        .email-list {
            flex: 1;
            overflow-y: auto;
        }

        .email-item {
            padding: 12px 16px;
            border-bottom: 1px solid #edebe9;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            min-height: 120px;
        }

        .email-item:hover {
            background: #faf9f8;
        }

        .email-item.selected {
            background: #e1dfdd;
        }

        .email-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .email-from {
            font-weight: 600;
            font-size: 14px;
            color: #323130;
        }

        .email-time {
            font-size: 12px;
            color: #605e5c;
        }

        .email-subject {
            font-size: 14px;
            color: #323130;
            margin-bottom: 4px;
        }

        .email-preview {
            font-size: 13px;
            color: #605e5c;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 8px;
        }

        .sentiment-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }

        .sentiment-happy {
            background: #e7f6e7;
            color: #0b7209;
        }

        .sentiment-complimentary {
            background: #e7f3ff;
            color: #004578;
        }

        .sentiment-angry {
            background: #fde7e9;
            color: #a4262c;
        }

        .sentiment-complaining {
            background: #fff4ce;
            color: #8a6100;
        }

        .sentiment-political {
            background: #f3e5f5;
            color: #5c2d91;
        }

        .sentiment-sad {
            background: #f3f2f1;
            color: #605e5c;
        }

        .sentiment-neutral {
            background: #f3f2f1;
            color: #605e5c;
        }

        .sentiment-positive {
            background: #e7f6e7;
            color: #0b7209;
        }

        .sentiment-negative {
            background: #fde7e9;
            color: #a4262c;
        }

        .sentiment-mixed {
            background: #fff4ce;
            color: #8a6100;
        }

        .sentiment-concerned {
            background: #e7f3ff;
            color: #004578;
        }

        .sentiment-complaint {
            background: #fde7e9;
            color: #a4262c;
        }

        .sentiment-praise {
            background: #e7f6e7;
            color: #0b7209;
        }

        .sentiment-request {
            background: #e7f3ff;
            color: #004578;
        }

        .sentiment-concern {
            background: #fff4ce;
            color: #8a6100;
        }

        .sentiment-suggestion {
            background: #e7e6ff;
            color: #5c2d91;
        }

        .sentiment-question {
            background: #f3f2f1;
            color: #605e5c;
        }

        .sentiment-badge.sentiment-political:hover {
            background: #e3d7e5;
            text-decoration: underline;
        }

        /* Tag container styling */
        .email-item>div:last-child {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
            max-height: 60px;
            overflow-y: auto;
        }

        .detail-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .detail-panel.ai-open {
            margin-right: 380px;
        }

        .detail-header {
            padding: 16px;
            border-bottom: 1px solid #edebe9;
        }

        .detail-toolbar {
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: 1px solid #edebe9;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-btn:hover {
            background: #faf9f8;
        }

        .toolbar-btn.primary {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .toolbar-btn.primary:hover {
            background: #106ebe;
        }

        .ai-toggle-toolbar-btn {
            margin-left: auto;
            padding: 8px 16px;
            border: 1px solid #5c2d91;
            border-radius: 4px;
            background: white;
            color: #5c2d91;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-toggle-toolbar-btn:hover {
            background: #5c2d91;
            color: white;
        }

        .ai-toggle-toolbar-btn.active {
            background: #5c2d91;
            color: white;
        }

        .detail-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            max-height: calc(100vh - 48px - 64px);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #605e5c;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .dashboard-view {
            padding: 24px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 600;
            color: #0078d4;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #605e5c;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 18px;
            margin-bottom: 16px;
            color: #323130;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .ai-assistant {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .ai-panel {
            position: fixed;
            right: -380px;
            top: 48px;
            width: 380px;
            height: calc(100vh - 48px);
            background: white;
            border-left: 1px solid #edebe9;
            transition: right 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .ai-panel.open {
            right: 0;
        }

        .ai-panel-header {
            padding: 16px;
            border-bottom: 1px solid #edebe9;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #5c2d91;
        }

        .ai-close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            color: #605e5c;
            font-size: 16px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .ai-close-btn:hover {
            background: #f3f2f1;
            color: #323130;
        }

        .ai-panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .context-badge {
            margin: 16px;
            padding: 8px 16px;
            background: #faf9f8;
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #605e5c;
            align-self: flex-start;
        }

        .ai-chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5c2d91;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #0078d4;
        }

        .message-content {
            max-width: 80%;
            padding: 12px;
            background: #f3f2f1;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #e7f3ff;
        }

        .suggestion-buttons {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .suggestion-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #edebe9;
            border-radius: 4px;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: #faf9f8;
            border-color: #0078d4;
            color: #0078d4;
        }

        .chat-input-group {
            padding: 16px;
            border-top: 1px solid #edebe9;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #edebe9;
            border-radius: 4px;
            font-size: 14px;
        }

        .members-view {
            padding: 24px;
        }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .member-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .member-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .member-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .member-role {
            font-size: 14px;
            color: #0078d4;
            margin-bottom: 8px;
        }

        .member-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .member-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #e7f3ff;
            color: #004578;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .member-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #edebe9;
        }

        .member-stat {
            text-align: center;
        }

        .member-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #0078d4;
        }

        .member-stat-label {
            font-size: 12px;
            color: #605e5c;
        }

        .member-bio {
            font-size: 14px;
            color: #605e5c;
            line-height: 1.5;
        }

        .member-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .member-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .member-modal-header {
            padding: 24px;
            border-bottom: 1px solid #edebe9;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .member-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            color: #605e5c;
            font-size: 20px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .member-modal-close:hover {
            background: #f3f2f1;
            color: #323130;
        }

        .member-modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .member-detail-header {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .member-detail-avatar {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
        }

        .member-detail-info {
            flex: 1;
        }

        .member-achievements {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .achievement {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #faf9f8;
            border-radius: 8px;
        }

        .achievement-icon {
            font-size: 24px;
        }

        .achievement-text {
            flex: 1;
            font-size: 14px;
        }

        @keyframes highlight-from-chat {
            0% {
                background-color: #fff4ce;
            }

            100% {
                background-color: transparent;
            }
        }

        .highlight-from-chat {
            animation: highlight-from-chat 0.5s ease-out;
        }

        /* Topic filter section in dashboard */
        .topic-filter-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .topic-card {
            background: #faf9f8;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .topic-card:hover {
            background: #e1dfdd;
            border-color: #0078d4;
            transform: translateY(-2px);
        }

        .topic-card-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #323130;
        }

        .topic-card-count {
            font-size: 24px;
            color: #0078d4;
            font-weight: 600;
        }

        /* AI Compose Feature Styles */
        .compose-ai-btn {
            background: linear-gradient(135deg, #c41e3a, #c41e3a);
            color: white;
            border: none;
            padding: 10px 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(92, 45, 145, 0.2);
        }

        .compose-ai-btn:hover {
            background: linear-gradient(135deg, #c41e3a, #c41e3a);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }

        .list-header-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            /* align-items: center; */
            gap: 10px;
        }

        .compose-ai-btn-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            background-color: #faf9f8;
            /* border: 1px solid #edebe9; */
            padding: 10px 20px;
            /* border-radius: 8px; */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .compose-ai-btn-container button {
            /* margin-left: 10px; */
        }

        .search-container {
            flex: 1;
            position: relative;
        }

        .search-container .search-icon {
            position: absolute;
            left: 12px;
            top: 8px;
            color: #605e5c;
        }

        /* Compose Modal */
        .compose-modal.maximized {
            align-items: flex-start;
            justify-content: center;
            padding-top: 2vh;
        }

        .compose-modal.maximized .compose-modal-content {
            width: 80vw;
            height: 95vh;
            max-width: none;
            max-height: none;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .compose-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .compose-modal.active {
            display: flex;
        }

        .compose-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .compose-modal-header {
            padding: 20px;
            border-bottom: 1px solid #edebe9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compose-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #323130;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .compose-modal-title i {
            color: #c41e3a;
        }

        .compose-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #605e5c;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .compose-close-btn:hover {
            background: #f3f2f1;
        }

        .maximize-icon {
            font-size: 13px;
            margin-right: 5px;
            position: relative;
            top: -2px;
            cursor: pointer;
            color: #605e5c;
            padding: 7px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .maximize-icon:hover {
            background: #f3f2f1;
        }

        .compose-modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .compose-input-section {
            margin-bottom: 24px;
        }

        .compose-input-label {
            font-size: 14px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 8px;
            display: block;
        }

        .compose-prompt-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #edebe9;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .compose-prompt-input:focus {
            outline: none;
            border-color: #c41e3a;
        }

        .compose-tone-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tone-selector {
            padding: 8px 12px;
            border: 1px solid #edebe9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .tone-selector:focus {
            outline: none;
            border-color: #c41e3a;
        }

        .compose-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #c41e3a, #c41e3a);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: linear-gradient(135deg, #c41e3a, #c41e3a);
            transform: translateY(-1px);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .regenerate-btn {
            background: #f3f2f1;
            color: #323130;
            border: 1px solid #edebe9;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .regenerate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #aiModeToggle:disabled {
            cursor: not-allowed;
            transform: none;
        }

        #aiInlineModeToggle:disabled {
            cursor: not-allowed;
            transform: none;
        }

        .regenerate-btn:hover {
            background: #e1dfdd;
        }

        .reply-inline-btn {
            background: #c41e3a;
            color: white;
            border: 1px solid #c41e3a;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .reply-inline-btn:hover {
            background: #c41e3a;
            border-color: #c41e3a;
        }

        /* Inline reply styling */
        .inline-reply-intro {
            margin-bottom: 20px;
            font-weight: 500;
        }

        .inline-reply-original {
            color: #6b7280;
            font-style: italic;
            margin-bottom: 8px;
            padding: 8px 12px;
            background-color: #f9fafb;
            border-radius: 4px;
        }

        .inline-reply-response {
            margin-bottom: 16px;
            padding: 12px 20px;
            border-left: 3px solid #c41e3a;
            background-color: #f8fafc;
            border-radius: 0 4px 4px 0;
        }

        .inline-reply-closing {
            margin-top: 20px;
            font-weight: 500;
        }

        .compose-draft-section {
            border: 1px solid #edebe9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        /* Ensure Froala toolbar stays within the draft section */
        .compose-draft-section .fr-toolbar {
            position: relative !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 10 !important;
            margin: 0 !important;
            transform: none !important;
        }

        .compose-draft-section .fr-box {
            position: relative;
            overflow: visible;
        }

        /* Prevent toolbar from floating outside modal */
        .compose-modal .fr-toolbar.fr-top {
            position: relative !important;
            top: auto !important;
            left: auto !important;
            right: auto !important;
            transform: none !important;
        }

        /* Ensure the editor wrapper doesn't overflow */
        .compose-draft-section .fr-wrapper {
            overflow: visible;
        }

        /* Loading overlay for draft generation */
        .draft-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 8px;
        }

        .draft-loading-content {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f2f1;
            border-top: 3px solid #c41e3a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Additional constraints for Froala editor within draft section */
        .compose-draft-section {
            contain: layout;
        }

        .compose-draft-section .fr-toolbar {
            width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Ensure modal body contains the editor properly */
        .compose-modal-body {
            position: relative;
            contain: layout;
        }

        .compose-draft-header {
            background: #faf9f8;
            padding: 12px 16px;
            border-bottom: 1px solid #edebe9;
            font-size: 14px;
            font-weight: 600;
            color: #323130;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            color: #605e5c;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            background-color: #ccc;
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: #c41e3a;
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-switch:hover .toggle-slider {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-label {
            font-weight: 500;
            user-select: none;
        }

        .compose-draft-content {
            /* padding: 16px; */
            min-height: 200px;
            font-size: 14px;
            line-height: 1.5;
            background: white;
            border: none;
            outline: none;
            resize: none;
            width: 100%;
            font-family: inherit;
        }

        /* Froala Editor styles */
        .fr-toolbar.fr-top {
            border: none;
            border-radius: 0;
        }

        .fr-box.fr-basic .fr-wrapper {
            border: none;
        }

        .fr-toolbar .fr-command.fr-btn i,
        .fr-toolbar .fr-command.fr-btn svg,
        .fr-popup .fr-command.fr-btn i,
        .fr-popup .fr-command.fr-btn svg,
        .fr-modal .fr-command.fr-btn i,
        .fr-modal .fr-command.fr-btn svg {
            width: 16px;
        }

        .fr-second-toolbar {
            border: none;
        }

        .fr-second-toolbar a {
            display: none;
        }

        .compose-modal-footer {
            padding: 20px;
            border-top: 1px solid #edebe9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compose-send-actions {
            display: flex;
            gap: 12px;
        }

        .send-btn {
            background: #c41e3a;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .send-btn:hover {
            background: #c41e3a;
        }

        .send-btn:disabled {
            background: #f3f2f1;
            color: #a19f9d;
            cursor: not-allowed;
        }

        .schedule-btn {
            background: #f3f2f1;
            color: #323130;
            border: 1px solid #edebe9;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .schedule-btn:hover {
            background: #e1dfdd;
        }

        /* Reply Section */
        .reply-section {
            display: none;
            border-top: 1px solid #e5e7eb;
        }

        .reply-section.active {
            display: block;
        }

        .reply-header {
            padding: 20px 24px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reply-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        .ai-badge {
            /* background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); */
            background: #c41e3a;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .reply-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: white;
            border: 1px solid #e5e7eb;
            color: #374151;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .action-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        /* Email Editor */
        .email-editor {
            /* padding: 24px; */
            min-height: 300px;
            outline: none;
            line-height: 1.8;
            font-size: 14px;
        }

        .email-editor.editable-mode {
            cursor: text;
        }

        .email-editor.editable-mode[contenteditable="true"]:focus {
            /* outline: 2px solid #e0e7ff; */
            outline: 2px solid rgba(196, 30, 58, 0.15);
            outline-offset: -2px;
            border-radius: 8px;
        }

        /* AI Sentence - Normal state (no highlighting) */
        .ai-sentence {
            display: inline;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .ai-sentence:hover {
            color: #c41e3a;
        }

        /* List item styling in AI mode */
        .ai-sentence.list-item {
            display: block;
            margin: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .ai-sentence.list-item[data-list-type="ol"] {
            counter-increment: list-counter;
        }

        .ai-sentence.list-item[data-list-type="ol"]:before {
            content: counter(list-counter) ". ";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .ai-sentence.list-item[data-list-type="ul"]:before {
            content: " ";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        /* Reset counter for new lists */
        .email-editor {
            counter-reset: list-counter;
        }

        /* Smart box on hover */
        .smart-box-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .smart-box {
            background: #f3f2f1;
            border: 1px solid #d1d0ce;
            border-radius: 8px;
            padding: 12px;
            margin: 4px 0;
            position: relative;
            /* box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15); */
            box-shadow: 0 2px 8px rgba(196, 30, 58, 0.15);
            animation: expandIn 0.2s ease;
        }

        @keyframes expandIn {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .smart-box-label {
            position: absolute;
            top: -8px;
            left: 12px;
            background: #fde7e9;
            padding: 0 6px;
            font-size: 10px;
            border-radius: 3px;
            color: #c41e3a;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .smart-box-content {
            outline: none;
            line-height: 1.6;
            color: #1a1a1a;
            min-height: 24px;
        }

        .smart-box-content:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            font-style: italic;
        }

        .smart-box-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .smart-box:hover .smart-box-actions {
            opacity: 1;
        }

        .micro-action {
            font-size: 11px;
            color: #6b7280;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
            font-weight: 500;
        }

        .micro-action:hover {
            background: #f3f4f6;
            /* border-color: #6366f1; */
            border-color: #c41e3a;
            /* color: #4f46e5; */
            color: #c41e3a;
        }

        .micro-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f9f9f9;
            color: #9ca3af;
        }

        .ai-loading {
            color: #c41e3a;
            font-style: italic;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from {
                opacity: 0.6;
            }

            to {
                opacity: 1;
            }
        }

        /* Send section */
        .send-section {
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .send-btn {
            /* background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); */
            background: #c41e3a;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-btn:hover {
            box-shadow: 0 4px 12px rgba(196, 30, 58, 0.15);
            transform: translateY(-1px);
        }

        /* Tone Switch Selector for AI Reply */
        .tone-switchr {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tone-chip {
            background: white;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tone-chip:hover {
            background: #fde7e9;
            border-color: #c41e3a;
            color: #c41e3a;
        }

        .tone-chip.active {
            color: #c41e3a;
            border-color: #c41e3a;
        }

        /* Paragraph styles for editing */
        .paragraph {
            margin: 16px 0;
            min-height: 24px;
            /* Ensure empty paragraphs are clickable */
            position: relative;
        }

        .paragraph:focus {
            outline: none;
        }

        .paragraph:empty:before {
            content: '\200B';
            /* Zero-width space to maintain height */
        }

        /* Add line button */
        .add-line-container {
            position: relative;
            height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -8px 0;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Show plus button when hovering over the paragraph above it */
        .paragraph:hover+.add-line-container {
            opacity: 0.5;
        }

        /* Show plus button when hovering between paragraphs */
        .add-line-container:hover {
            opacity: 1 !important;
        }

        .add-line-btn {
            /* background: #6366f1; */
            background: #c41e3a;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .add-line-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(196, 30, 58, 0.15);
        }

        /* Make sure original text isn't editable */
        .original-text {
            color: #9ca3af;
            font-style: italic;
        }

        .inline-response {
            color: #1a1a1a;
            font-weight: normal;
            cursor: text;
            display: inline-block;
            transition: all 0.2s;
        }

        .inline-response:hover {
            background-color: rgba(99, 102, 241, 0.05);
            padding: 2px 4px;
            margin: -2px -4px;
            border-radius: 4px;
        }

        /* Inline edit mode */
        .inline-reply-mode .email-editor {
            outline: none;
        }

        .inline-reply-mode .email-editor[contenteditable="true"] {
            cursor: text;
        }

        @keyframes highlight {
            0% {
                background-color: rgba(196, 30, 58, 0.15);
            }

            100% {
                background-color: transparent;
            }
        }

        .regenerating {
            animation: highlight 0.5s ease;
        }

        .reply-with-ai-btn {
            padding: 8px 16px;
            background: #c41e3a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: background 0.3s;
        }

        .reply-with-ai-btn:hover {
            background: #a01729;
        }

        /* AI Queue */
        .ai-queue-container {
            padding: 24px;
            background: #faf9f8;
            height: 100%;
            overflow-y: auto;
        }

        .ai-queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .ai-queue-title {
            font-size: 24px;
            font-weight: 600;
            color: #323130;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-queue-title i {
            color: #5c2d91;
        }

        .ai-queue-stats {
            font-size: 14px;
            color: #605e5c;
        }

        .ai-queue-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-queue-filters {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .ai-queue-filter-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .ai-queue-filter-row:last-child {
            margin-bottom: 0;
        }

        .ai-queue-filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #323130;
            min-width: 80px;
        }

        .ai-queue-filter-chip {
            padding: 6px 12px;
            border: 1px solid #edebe9;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .ai-queue-filter-chip:hover {
            background: #f3f2f1;
        }

        .ai-queue-filter-chip.active {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }

        .ai-queue-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ai-queue-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #edebe9;
            transition: all 0.3s;
        }

        .ai-queue-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .ai-queue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .ai-queue-item-info {
            flex: 1;
        }

        .ai-queue-item-subject {
            font-size: 16px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .ai-queue-item-from {
            font-size: 14px;
            color: #605e5c;
            margin-bottom: 8px;
        }

        .ai-queue-item-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: #605e5c;
        }

        .ai-queue-item-actions {
            display: flex;
            gap: 8px;
        }

        .ai-queue-action-btn {
            padding: 8px 16px;
            border: 1px solid #edebe9;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .ai-queue-send-btn {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }

        .ai-queue-send-btn:hover {
            background: #c41e3a;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ai-queue-edit-btn {
            background: white;
            color: #323130;
        }

        .ai-queue-edit-btn:hover {
            background: #f3f2f1;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ai-queue-dismiss-btn {
            background: #f3f2f1;
            color: #605e5c;
        }

        .ai-queue-dismiss-btn:hover {
            background: #e1dfdd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ai-queue-reply-preview {
            background: #faf9f8;
            border: 1px solid #edebe9;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            font-size: 14px;
            line-height: 1.5;
            max-height: 150px;
        }

        .ai-queue-inline-replies {
            margin-top: 12px;
        }

        .ai-queue-inline-item {
            background: #f8f9fa;
            border-left: 3px solid #5c2d91;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
        }

        .ai-queue-inline-original {
            font-size: 13px;
            color: #605e5c;
            margin-bottom: 8px;
            font-style: italic;
        }

        .ai-queue-inline-response {
            font-size: 14px;
            color: #323130;
        }

        .ai-queue-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            gap: 4px;
        }

        .ai-queue-status-ready {
            background: #e7f6e7;
            color: #0b7209;
        }

        .ai-queue-status-review {
            background: #fff4ce;
            color: #8a6100;
        }

        .ai-queue-status-processing {
            background: #e7f3ff;
            color: #004578;
        }

        .ai-queue-empty {
            text-align: center;
            padding: 40px;
            color: #605e5c;
        }

        .ai-queue-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .ai-queue-bulk-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .bulk-action-btn {
            padding: 8px 16px;
            border: 1px solid #edebe9;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bulk-send-btn {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }

        .bulk-dismiss-btn {
            background: #f3f2f1;
            color: #605e5c;
        }

        .email-editor {
            /* padding: 24px; */
            min-height: 300px;
            outline: none;
            line-height: 1.8;
            font-size: 14px;
        }

        .email-editor.editable-mode {
            cursor: text;
        }

        .email-editor.editable-mode[contenteditable="true"]:focus {
            /* outline: 2px solid #e0e7ff; */
            outline: 2px solid rgba(196, 30, 58, 0.15);
            outline-offset: -2px;
            border-radius: 8px;
        }

        .ai-edit-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            width: 400px;
            max-width: 90vw;
            display: none;
            font-family: Arial, sans-serif;
        }

        .ai-edit-popup.active {
            display: block;
        }

        .ai-edit-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .ai-edit-selected-text {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .ai-edit-selected-content {
            background: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            max-height: 100px;
            overflow-y: auto;
            word-wrap: break-word;
        }

        .ai-edit-options {
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .ai-edit-btn {
            padding: 10px 15px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-edit-btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        .ai-edit-btn.primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .ai-edit-btn.primary:hover {
            background: #0056b3;
            border-color: #0056b3;
        }

        .ai-edit-loading {
            padding: 20px;
            text-align: center;
            display: none;
            color: #666;
        }

        .ai-edit-loading.active {
            display: block;
        }

        .ai-edit-preview {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }

        .ai-edit-preview-label {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .ai-edit-preview-text {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.4;
            max-height: 150px;
            overflow-y: auto;
        }

        .ai-edit-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .ai-edit-accept {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .ai-edit-accept:hover {
            background: #218838;
        }

        .ai-edit-reject {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .ai-edit-reject:hover {
            background: #545b62;
        }

        #emailContent::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="header">
        <i class="fas fa-bullseye" style="font-size: 20px;"></i>
        <h1>NRA Member Communications Portal - AI Enhanced</h1>
        <div class="header-right">
            <div class="status-badge">
                <div class="status-dot"></div>
                <span id="connectionStatus">Connected</span>
            </div>
            <i class="fas fa-user-circle" style="font-size: 24px;"></i>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="compose-ai-btn-container">
                <button class="compose-ai-btn" onclick="openComposeModal('COMPOSE_WITH_AI')">
                    <i class="fas fa-robot"></i>
                    Compose with AI
                </button>
            </div>
            <a href="#" class="nav-item active" onclick="showView('emails')">
                <i class="fas fa-inbox"></i>
                <span>Inbox</span>
                <span class="nav-count" id="inboxCount">0</span>
            </a>
            </a>
            <a href="#" class="nav-item" onclick="showView('ai-queue')">
                <i class="fas fa-robot"></i>
                <span>AI Queue</span>
                <span class="nav-count" id="aiQueueCount">0</span>
            </a>
            <a href="#" class="nav-item" onclick="showView('priority')">
                <i class="fas fa-exclamation-circle"></i>
                <span>Priority</span>
                <span class="nav-count" id="priorityCount">0</span>
            </a>
            <a href="#" class="nav-item" onclick="showView('actions')">
                <i class="fas fa-tasks"></i>
                <span>Action Items</span>
                <span class="nav-count" id="actionCount">0</span>
            </a>
            <a href="#" class="nav-item" onclick="showView('dashboard')">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            <a href="#" class="nav-item" onclick="showView('insights')">
                <i class="fas fa-brain"></i>
                <span>AI Insights</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-archive"></i>
                <span>Archive</span>
            </a>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Email View -->
            <div id="emailView" class="view email-view-container" style="display: flex;">

                <!-- Global Filter Bar -->
                <div class="filter-bar">
                    <!-- Basic Filters Row -->
                    <div class="filter-row">
                        <div class="filter-chip active" onclick="filterEmails('all', this)">All</div>
                    </div>

                    <!-- Sentiment Filters Row -->
                    <div class="filter-row">
                        <span class="filter-category-label">SENTIMENT:</span>
                        <div class="filter-chip" onclick="filterBySentiment('complaint', this)">Complaint</div>
                        <div class="filter-chip" onclick="filterBySentiment('praise', this)">Praise</div>
                        <div class="filter-chip" onclick="filterBySentiment('request', this)">Request</div>
                        <div class="filter-chip" onclick="filterBySentiment('concern', this)">Concern</div>
                        <div class="filter-chip" onclick="filterBySentiment('suggestion', this)">Suggestion</div>
                        <div class="filter-chip" onclick="filterBySentiment('question', this)">Question</div>
                    </div>

                    <!-- Priority Filters Row -->
                    <div class="filter-row">
                        <span class="filter-category-label">PRIORITY:</span>
                        <div class="filter-chip" onclick="filterEmails('critical', this)">Critical (9-10)</div>
                        <div class="filter-chip" onclick="filterEmails('high', this)">High (7-8)</div>
                        <div class="filter-chip" onclick="filterEmails('medium', this)">Medium (5-6)</div>
                        <div class="filter-chip" onclick="filterEmails('low', this)">Low (1-4)</div>
                    </div>

                    <!-- Response Required Filters Row 
    <div class="filter-row">
        <span class="filter-category-label">RESPONSE:</span>
        <div class="filter-chip" onclick="filterEmails('response:yes-direct', this)">Direct Response</div>
        <div class="filter-chip" onclick="filterEmails('response:yes-complaint', this)">Complaint Response</div>
        <div class="filter-chip" onclick="filterEmails('response:yes-request', this)">Request Response</div>
        <div class="filter-chip" onclick="filterEmails('response:maybe', this)">Maybe</div>
        <div class="filter-chip" onclick="filterEmails('response:no', this)">No Response</div>
    </div>-->

                    <!-- Topic Category Filters Row 
    <div class="filter-row">
        <span class="filter-category-label">CATEGORY:</span>
        <div class="filter-chip" onclick="filterEmails('topic-category:membership', this)">Membership</div>
        <div class="filter-chip" onclick="filterEmails('topic-category:leadership', this)">Leadership</div>
        <div class="filter-chip" onclick="filterEmails('topic-category:political', this)">Political</div>
        <div class="filter-chip" onclick="filterEmails('topic-category:communications', this)">Communications</div>
        <div class="filter-chip" onclick="filterEmails('topic-category:operations', this)">Operations</div>
        <div class="filter-chip" onclick="filterEmails('topic-category:personal', this)">Personal</div>
    </div>-->

                    <!-- Dynamic Topic Filters Row -->
                    <div class="filter-row" id="dynamicTopicFilters"></div>
                </div>

                <!-- Email Content Area -->
                <div class="email-content-area">
                    <!-- Email List Panel -->
                    <div class="email-list-panel">
                        <!-- <div class="list-header">
                    <div style="position: relative;">
                        <i class="fas fa-search search-icon" style="position: absolute; left: 12px; top: 8px; color: #605e5c;"></i>
                        <input type="text" class="search-box" placeholder="Search emails" id="searchBox" onkeyup="searchEmails()">
                    </div>
                </div> -->
                        <div class="list-header">
                            <div class="list-header-content">
                                <div class="search-container">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="search-box" placeholder="Search emails" id="searchBox"
                                        onkeyup="searchEmails()">
                                </div>
                            </div>
                        </div>
                        <div class="email-list" id="emailList">
                            <!-- Emails will be populated here -->
                        </div>
                    </div>

                    <!-- Detail Panel -->
                    <div class="detail-panel" id="detailPanel">
                        <div id="emailDetail" style="display: none;">
                            <div class="detail-header">
                                <div class="detail-toolbar">
                                    <button class="toolbar-btn reply-with-ai-btn"
                                        onclick="openComposeModal('REPLY_WITH_AI')">
                                        <i class="fa-solid fa-reply"></i>
                                        Reply With AI <i class="fa-solid fa-robot"></i>
                                    </button>
                                    <button class="toolbar-btn">
                                        <i class="fas fa-reply"></i> Reply
                                    </button>
                                    <button class="toolbar-btn">
                                        <i class="fas fa-reply-all"></i> Reply All
                                    </button>
                                    <button class="toolbar-btn">
                                        <i class="fas fa-share"></i> Forward
                                    </button>
                                    <button class="toolbar-btn">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    <button class="toolbar-btn">
                                        <i class="fas fa-archive"></i> Archive
                                    </button>
                                    <button class="ai-toggle-toolbar-btn" id="aiToggleBtn" onclick="toggleAIPanel()">
                                        <i class="fas fa-robot"></i> AI Assistant
                                    </button>
                                </div>
                            </div>
                            <div class="detail-content" id="emailContent">
                                <!-- Email content will be displayed here -->
                            </div>
                        </div>
                        <div id="emptyDetail" class="empty-state">
                            <i class="fas fa-envelope-open"></i>
                            <p>Select an email to read</p>
                        </div>
                    </div>

                    <!-- AI Assistant Panel (Third Panel) -->
                    <div class="ai-panel" id="aiPanel">
                        <div class="ai-panel-header">
                            <div class="ai-panel-title">
                                <i class="fas fa-robot"></i>
                                AI Assistant
                            </div>
                            <button class="ai-close-btn" onclick="toggleAIPanel()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="ai-panel-content">
                            <div class="context-badge" id="contextBadge">
                                <i class="fas fa-inbox"></i>
                                <span id="contextText">Viewing Inbox</span>
                            </div>
                            <div class="ai-chat-container" id="aiChatContainer">
                                <div class="message">
                                    <div class="message-avatar">AI</div>
                                    <div class="message-content" id="aiWelcomeMessage">
                                        I'm here to help analyze your emails. I can see you're viewing the inbox. Try
                                        these questions:
                                        <div class="suggestion-buttons">
                                            <button class="suggestion-btn"
                                                onclick="askSuggestion('What\'s the most urgent issue in these emails?')">What's
                                                the most urgent issue in these emails?</button>
                                            <button class="suggestion-btn"
                                                onclick="askSuggestion('Summarize the concerns raised')">Summarize the
                                                concerns raised</button>
                                            <button class="suggestion-btn"
                                                onclick="askSuggestion('Who needs a response first?')">Who needs a
                                                response first?</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input-group">
                                <input type="text" class="chat-input" id="aiChatInput"
                                    placeholder="Ask about what you're viewing..."
                                    onkeypress="if(event.key==='Enter') sendAIMessage()">
                                <button class="toolbar-btn primary" onclick="sendAIMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Queue View -->
            <div id="ai-queueView" class="view ai-queue-container" style="display: none;">
                <div class="ai-queue-header">
                    <div class="ai-queue-title">
                        AI Queue
                    </div>
                    <div class="ai-queue-header-right">
                        <div class="ai-queue-stats">
                            <span id="aiQueueTotal">0</span> pending responses
                        </div>
                        <button class="toolbar-btn" onclick="deleteAllAIQueue()">
                            <i class="fas fa-broom"></i>
                            Clear All
                        </button>
                    </div>
                </div>

                <div class="ai-queue-filters">
                    <div class="ai-queue-filter-row">
                        <span class="ai-queue-filter-label">Status:</span>
                        <div class="ai-queue-filter-chip active" onclick="filterAIQueue('all', this)">All</div>
                        <div class="ai-queue-filter-chip" onclick="filterAIQueue('ready', this)">Ready to Send</div>
                        <div class="ai-queue-filter-chip" onclick="filterAIQueue('review', this)">Needs Review
                        </div>
                        <div class="ai-queue-filter-chip" onclick="filterAIQueue('sent', this)">Sent</div>
                    </div>
                    <div class="ai-queue-filter-row">
                        <span class="ai-queue-filter-label">Type:</span>
                        <div class="ai-queue-filter-chip" onclick="filterAIQueue('reply', this)">Replies</div>
                        <div class="ai-queue-filter-chip" onclick="filterAIQueue('compose', this)">Composed</div>
                    </div>
                    <div class="ai-queue-filter-row">
                        <span class="ai-queue-filter-label">Priority:</span>
                        <div class="ai-queue-filter-chip" onclick="filterAIQueue('high-priority', this)">High Priority
                        </div>
                        <div class="ai-queue-filter-chip" onclick="filterAIQueue('urgent', this)">Urgent</div>
                    </div>
                </div>

                <div class="ai-queue-bulk-actions" id="bulkActions" style="display: none;">
                    <button class="bulk-action-btn bulk-send-btn" onclick="bulkSendSelected()">
                        <i class="fas fa-paper-plane"></i>
                        Send Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button class="bulk-action-btn bulk-dismiss-btn" onclick="bulkDismissSelected()">
                        <i class="fas fa-times"></i>
                        Dismiss Selected
                    </button>
                </div>

                <div class="ai-queue-list" id="aiQueueList">
                    <div class="ai-queue-empty">
                        <i class="fas fa-robot"></i>
                        <h3>No AI-generated responses yet</h3>
                        <p>Use "Compose with AI" or "AI Reply" to create AI-assisted emails that will appear here for
                            review.</p>
                    </div>
                </div>
            </div>

            <!-- Priority View -->
            <div id="priorityView" class="view" style="display: none; padding: 24px;">
                <h2 style="margin-bottom: 24px;">Priority Emails</h2>

                <div class="filter-bar" style="margin-bottom: 24px;">
                    <div class="filter-chip active" onclick="filterPriority('all', this)">All Priorities</div>
                    <div class="filter-chip" onclick="filterPriority('high', this)">
                        <span class="priority-indicator priority-high"></span>High Priority
                    </div>
                    <div class="filter-chip" onclick="filterPriority('medium', this)">
                        <span class="priority-indicator priority-medium"></span>Medium Priority
                    </div>
                    <div class="filter-chip" onclick="filterPriority('low', this)">
                        <span class="priority-indicator priority-low"></span>Low Priority
                    </div>
                </div>

                <div id="priorityEmailsList">
                    <!-- Priority emails will be displayed here -->
                </div>
            </div>

            <!-- Action Items View -->
            <div id="actionsView" class="view" style="display: none; padding: 24px;">
                <h2 style="margin-bottom: 24px;">Action Items</h2>

                <div class="ai-insights-panel">
                    <div class="ai-insights-header">
                        <i class="fas fa-lightbulb"></i>
                        <h3>Action Summary</h3>
                    </div>
                    <div id="actionSummary">
                        <!-- AI summary of action items will appear here -->
                    </div>
                </div>

                <div class="action-items-list" id="actionItemsList">
                    <!-- Action items will be populated here -->
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboardView" class="view dashboard-view" style="display: none;">
                <h2 style="margin-bottom: 24px; font-size: 28px;">Analytics Dashboard</h2>

                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStat">0</div>
                        <div class="stat-label">Total Emails</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgPriorityStat">0</div>
                        <div class="stat-label">Avg Priority Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="requireActionStat">0</div>
                        <div class="stat-label">Require Action</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="analyzedStat">0</div>
                        <div class="stat-label">AI Analyzed</div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Sentiment Distribution</h3>
                        <div class="chart-container">
                            <canvas id="sentimentChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Urgency Distribution</h3>
                        <div class="chart-container">
                            <canvas id="urgencyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Top Topics</h3>
                        <div class="chart-container">
                            <canvas id="topicsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Top Senders by Volume</h3>
                        <div class="chart-container">
                            <canvas id="sendersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights View -->
            <div id="insightsView" class="view" style="display: none; padding: 24px;">
                <h2 style="margin-bottom: 24px;">AI Analysis & Insights</h2>

                <div class="ai-insights-panel" style="margin-bottom: 24px;">
                    <div class="ai-insights-header">
                        <i class="fas fa-chart-line"></i>
                        <h3>Executive Summary</h3>
                    </div>
                    <div id="executiveSummary" style="font-size: 16px; line-height: 1.8; color: #323130;">
                        <!-- Executive summary will be populated here -->
                    </div>
                </div>

                <div class="ai-insights-panel" style="margin-bottom: 24px;">
                    <div class="ai-insights-header">
                        <i class="fas fa-key"></i>
                        <h3>Key Points</h3>
                    </div>
                    <ul id="keyPoints" style="font-size: 15px; line-height: 1.8; padding-left: 20px;">
                        <!-- Key points will be populated here -->
                    </ul>
                </div>

                <div class="ai-insights-panel" style="margin-bottom: 24px;">
                    <div class="ai-insights-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Risks & Opportunities</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h4 style="color: #a4262c; margin-bottom: 12px;">Risks</h4>
                            <ul id="risksList" style="font-size: 14px; line-height: 1.6; color: #605e5c;">
                                <!-- Risks will be populated here -->
                            </ul>
                        </div>
                        <div>
                            <h4 style="color: #10c510; margin-bottom: 12px;">Opportunities</h4>
                            <ul id="opportunitiesList" style="font-size: 14px; line-height: 1.6; color: #605e5c;">
                                <!-- Opportunities will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="ai-insights-panel">
                    <div class="ai-insights-header">
                        <i class="fas fa-user-friends"></i>
                        <h3>Key Stakeholders</h3>
                    </div>
                    <div id="stakeholdersList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Stakeholders will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Compose Modal -->
    <div class="compose-modal" id="composeModal">
        <div class="compose-modal-content">
            <div class="compose-modal-header">
                <div class="compose-modal-title" id="composeModalTitle">
                    <i class="fas fa-robot"></i>
                    Compose with AI
                </div>
                <div>
                    <i class="fa-solid fa-up-right-and-down-left-from-center maximize-icon"
                        onclick="openMaximizeMode()"></i>
                    <i class="fas fa-times compose-close-btn" onclick="closeComposeModal()"></i>
                </div>
            </div>

            <div class="compose-modal-body" id="composeModalBody">
                <div class="compose-input-section" id="composeInputView">
                    <label class="compose-input-label">What do you want to communicate?</label>
                    <textarea class="compose-prompt-input" id="composePrompt"
                        placeholder="Describe what you want to say. For example: 'I need to thank members for their support during the recent legislative session and update them on upcoming events.'"></textarea>
                </div>

                <div class="compose-tone-section">
                    <label class="compose-input-label">Tone:</label>
                    <select class="tone-selector" id="toneSelector">
                        <option value="professional">Professional</option>
                        <option value="formal">Formal</option>
                        <option value="friendly">Friendly</option>
                        <option value="casual">Casual</option>
                        <option value="urgent">Urgent</option>
                        <option value="grateful">Grateful</option>
                        <option value="informative">Informative</option>
                    </select>
                </div>

                <div class="compose-actions">
                    <button class="generate-btn" onclick="generateEmailDraft()">
                        <i class="fas fa-magic"></i>
                        Generate Draft
                    </button>
                    <button class="regenerate-btn" onclick="regenerateEmailDraft()" style="display: none;"
                        id="regenerateBtn">
                        <i class="fas fa-redo"></i>
                        Regenerate Inline
                    </button>
                    <button class="reply-inline-btn" onclick="regenerateEmailDraft()" style="display: none;"
                        id="replyInlineBtn">
                        <i class="fas fa-reply"></i>
                        Reply Inline
                    </button>
                </div>

                <div class="compose-draft-section" id="draftSection" style="display: none;">
                    <div class="compose-draft-header">
                        <span>AI Generated Draft</span>
                        <div class="editor-mode-toggle">
                            <label class="toggle-switch" style="display: none;" id="aiInlinModeSwitch">
                                <input type="checkbox" id="aiInlineModeToggle" onchange="toggleInlineAIMode(this)">
                                <!-- <input type="checkbox" id="aiModeToggle"> -->
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">AI Edit Paragraph</span>
                            </label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="aiModeToggle" onchange="toggleAIMode(this)">
                                <!-- <input type="checkbox" id="aiModeToggle"> -->
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">AI Edit Sentence</span>
                            </label>
                        </div>
                    </div>
                    <!-- <textarea class="compose-draft-content" id="draftContent"
                        placeholder="Your AI-generated draft will appear here..."></textarea> -->
                    <!-- Text Editor -->
                    <div class="compose-draft-content" id="draftContent"></div>


                    <!-- AI Editor (Initially hidden) -->
                    <div class="email-editor editable-mode" id="aiDraftEditor" style="display: none;">
                        <!-- AI-style editor content will be populated here -->
                    </div>
                </div>

            </div>

            <div class="compose-modal-footer">
                <div class="compose-send-actions">
                    <button class="send-btn" onclick="saveToAIQueue()" id="sendEmailBtn" disabled
                        title="Save to AI Queue">
                        <i class="fas fa-save"></i>
                        Save
                    </button>
                    <button class="schedule-btn" onclick="scheduleEmail()">
                        <i class="fas fa-clock"></i>
                        Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Configuration
        const API_BASE_URL = window.location.origin + '/api';
        let emailData = { emails: [], summary: {} };
        let currentFilter = 'all';
        let selectedEmail = null;
        let charts = {};
        let currentView = 'emails';
        let aiPanelOpen = false;
        let topTopicsList = [];

        // Multi-select filter state
        let activeFilters = {
            sentiment: [],
            priority: [],
            response: [],
            category: [],
            topics: []
        };

        // Helper function to extract name from email
        function extractNameFromEmail(email) {
            const username = email.split('@')[0];
            const name = username
                .replace(/[._-]/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
            return name;
        }

        // Helper function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    return diffMinutes === 0 ? 'Just now' : `${diffMinutes} minutes ago`;
                }
                return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Initialize
        window.onload = async function () {
            await loadData();
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 500);
        };

        async function loadData() {
            try {
                // Load emails with AI analysis
                const emailResponse = await fetch(`${API_BASE_URL}/emails`);
                emailData = await emailResponse.json();

                // Load stats
                const statsResponse = await fetch(`${API_BASE_URL}/stats`);
                const stats = await statsResponse.json();

                // Load action items
                const actionResponse = await fetch(`${API_BASE_URL}/action-items`);
                const actionData = await actionResponse.json();

                updateCounts(stats, actionData);

                // Create topic filter chips
                if (stats.topics) {
                    createTopicFilters(stats.topics);
                }

                displayEmails('all');
                displayAIInsights(stats);
                initCharts(stats);

                // Add topic overview to dashboard
                setTimeout(() => {
                    addTopicOverviewToDashboard();
                }, 100);

                // Check connection
                const healthResponse = await fetch(`${API_BASE_URL}/health`);
                const health = await healthResponse.json();

                if (health.openai !== 'configured') {
                    document.getElementById('connectionStatus').textContent = 'Connected (No AI)';
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('connectionStatus').textContent = 'Offline';
            }
        }

        function updateCounts(stats, actionData) {
            document.getElementById('inboxCount').textContent = stats.total || 0;
            document.getElementById('totalStat').textContent = stats.total || 0;
            document.getElementById('avgPriorityStat').textContent = (stats.avgPriorityScore || 0).toFixed(1);
            document.getElementById('requireActionStat').textContent = stats.emailsRequiringAction || 0;
            document.getElementById('analyzedStat').textContent = stats.analyzed || 0;

            // Count high priority emails
            const highPriorityCount = emailData.emails.filter(e =>
                e.analysis && e.analysis.priority_score >= 6
            ).length;
            document.getElementById('priorityCount').textContent = highPriorityCount;

            // Count action items
            document.getElementById('actionCount').textContent = actionData?.actionItems?.length || 0;
        }

        function createEmailListItem(email, originalIndex) {
            const emailDiv = document.createElement('div');
            emailDiv.className = 'email-item';
            emailDiv.setAttribute('data-email-index', originalIndex);
            emailDiv.onclick = () => selectEmail(email);

            // Extract sender name
            const senderName = extractNameFromEmail(email.sender);

            // Format date
            const formattedDate = email.date ? formatDate(email.date) : '2 days ago';

            // Get analysis data
            const analysis = email.analysis || {};

            // Priority level and score
            const priorityScore = analysis.priority_score || 0;
            let priorityLevel = 'low';
            if (priorityScore >= 7) priorityLevel = 'high';
            else if (priorityScore >= 5) priorityLevel = 'medium';

            // Build tag badges HTML
            let tagBadges = '';

            // 1. Sentiment Category Badge (enhanced)
            if (analysis.sentiment_category) {
                tagBadges += `<span class="sentiment-badge sentiment-${analysis.sentiment_category}">${analysis.sentiment_category}</span>`;
            } else if (analysis.sentiment?.ai_analysis?.overall_sentiment) {
                // Fallback to old structure
                const sentiment = analysis.sentiment.ai_analysis.overall_sentiment;
                tagBadges += `<span class="sentiment-badge sentiment-${sentiment}">${sentiment}</span>`;
            }

            // 2. Emotional Temperature Badge
            if (analysis.emotional_temperature) {
                const tempColors = {
                    'hot': 'angry',
                    'warm': 'complimentary',
                    'cool': 'neutral',
                    'cold': 'political'
                };
                tagBadges += `<span class="sentiment-badge sentiment-${tempColors[analysis.emotional_temperature] || 'neutral'}">${analysis.emotional_temperature}</span>`;
            }

            // 3. Priority/Urgency Badge
            if (analysis.priority_level) {
                tagBadges += `<span class="sentiment-badge sentiment-${priorityLevel === 'high' ? 'angry' : priorityLevel === 'medium' ? 'complaining' : 'neutral'}">${analysis.priority_level} priority</span>`;
            }

            // 4. Response Required Badge
            if (analysis.response_required && analysis.response_required !== 'no') {
                const responseColors = {
                    'yes-direct': 'angry',
                    'yes-complaint': 'complaining',
                    'yes-request': 'political',
                    'maybe': 'neutral'
                };
                const responseLabels = {
                    'yes-direct': 'needs response',
                    'yes-complaint': 'complaint response',
                    'yes-request': 'request response',
                    'maybe': 'may need response'
                };
                tagBadges += `<span class="sentiment-badge sentiment-${responseColors[analysis.response_required] || 'neutral'}">${responseLabels[analysis.response_required] || analysis.response_required}</span>`;
            }

            // 5. Topic Category Badge
            if (analysis.topic_category) {
                tagBadges += `<span class="sentiment-badge sentiment-political" style="cursor: pointer;" onclick="event.stopPropagation(); filterByTopic('${analysis.topic_category}')">${analysis.topic_category}</span>`;
            }

            // 6. Specific Topics Badges
            if (analysis.specific_topics && analysis.specific_topics.length > 0) {
                analysis.specific_topics.slice(0, 2).forEach(topic => {
                    tagBadges += `<span class="sentiment-badge sentiment-political" style="cursor: pointer;" onclick="event.stopPropagation(); filterByTopic('${topic}')">${topic}</span>`;
                });
            }

            // 7. Intent Badge
            if (analysis.primary_intent && analysis.primary_intent !== 'inform') {
                tagBadges += `<span class="sentiment-badge sentiment-neutral">intent: ${analysis.primary_intent}</span>`;
            }

            // 8. Sender Category Badge
            if (analysis.sender_category && analysis.sender_category !== 'new') {
                const senderColors = {
                    'active': 'complimentary',
                    'regular': 'neutral',
                    'lapsed': 'complaining',
                    'vip': 'happy'
                };
                tagBadges += `<span class="sentiment-badge sentiment-${senderColors[analysis.sender_category] || 'neutral'}">${analysis.sender_category} sender</span>`;
            }

            // 9. Risk Indicators Badge
            if (analysis.risk_indicators && analysis.risk_indicators.length > 0) {
                tagBadges += `<span class="sentiment-badge sentiment-angry"> risk</span>`;
            }

            // 10. Opportunities Badge
            if (analysis.opportunities && analysis.opportunities.length > 0) {
                tagBadges += `<span class="sentiment-badge sentiment-happy"> opportunity</span>`;
            }

            // Use enhanced summary or fallback
            const preview = analysis.summary ||
                (email.clean_text ? email.clean_text.substring(0, 100) + '...' :
                    'Click to view email content');

            // Priority indicator color based on score
            const priorityColor = priorityScore >= 7 ? '#d13438' : priorityScore >= 5 ? '#ffb900' : '#10c510';

            emailDiv.innerHTML = `
            <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background-color: ${priorityColor};"></div>
            <div class="email-header-row">
                <div class="email-from">${senderName}</div>
                <div style="display: flex; align-items: center;">
                    <div class="email-time">${formattedDate}</div>
                    <span class="priority-score ${priorityLevel}">${priorityScore.toFixed(1)}</span>
                </div>
            </div>
            <div class="email-subject">${email.subject}</div>
            <div class="email-preview">${preview}</div>
            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
                ${tagBadges}
            </div>
        `;

            return emailDiv;
        }

        // Multi-select filter functions
        function filterBySentiment(sentiment, element) {
            toggleFilter('sentiment', sentiment, element);
            applyFilters();
        }

        function filterEmails(filter, element) {
            // Handle "All" filter specially
            if (filter === 'all') {
                clearAllFilters();
                element.classList.add('active');
                displayEmails('all');
                return;
            }

            // Determine filter type and value
            if (filter === 'critical' || filter === 'high' || filter === 'medium' || filter === 'low') {
                toggleFilter('priority', filter, element);
            } else if (filter.startsWith('response:')) {
                toggleFilter('response', filter, element);
            } else if (filter.startsWith('topic-category:')) {
                toggleFilter('category', filter, element);
            }

            applyFilters();
        }

        function filterByTopic(topic, element) {
            toggleFilter('topics', 'topic:' + topic, element);
            applyFilters();
        }

        function toggleFilter(filterType, filterValue, element) {
            // Remove active state from "All" filter
            const allFilter = document.querySelector('.filter-chip[onclick*="all"]');
            if (allFilter) allFilter.classList.remove('active');

            const filterArray = activeFilters[filterType];
            const index = filterArray.indexOf(filterValue);

            if (index > -1) {
                // Remove filter
                filterArray.splice(index, 1);
                if (element) element.classList.remove('active');
            } else {
                // Add filter
                filterArray.push(filterValue);
                if (element) element.classList.add('active');
            }

            // If no filters are active, activate "All"
            const hasActiveFilters = Object.values(activeFilters).some(arr => arr.length > 0);
            if (!hasActiveFilters && allFilter) {
                allFilter.classList.add('active');
            }
        }

        function applyFilters() {
            const emailList = document.getElementById('emailList');
            emailList.innerHTML = '';

            // Check if any filters are active
            const hasActiveFilters = Object.values(activeFilters).some(arr => arr.length > 0);

            if (!hasActiveFilters) {
                displayEmails('all');
                return;
            }

            // Filter emails based on all active filters
            let filtered = emailData.emails.filter(email => {
                // Check sentiment filters
                if (activeFilters.sentiment.length > 0) {
                    const matchesSentiment = activeFilters.sentiment.some(sentiment => {
                        if (email.analysis?.sentiment_category === sentiment) return true;
                        if (email.analysis?.sentiment?.ai_analysis?.overall_sentiment === sentiment) return true;
                        if (email.analysis?.sentiment?.classification === sentiment) return true;
                        return false;
                    });
                    if (!matchesSentiment) return false;
                }

                // Check priority filters
                if (activeFilters.priority.length > 0) {
                    const priorityScore = email.analysis?.priority_score || 0;
                    const matchesPriority = activeFilters.priority.some(priority => {
                        switch (priority) {
                            case 'critical': return priorityScore >= 9;
                            case 'high': return priorityScore >= 7 && priorityScore < 9;
                            case 'medium': return priorityScore >= 5 && priorityScore < 7;
                            case 'low': return priorityScore >= 1 && priorityScore < 5;
                            default: return false;
                        }
                    });
                    if (!matchesPriority) return false;
                }

                // Check response filters
                if (activeFilters.response.length > 0) {
                    const matchesResponse = activeFilters.response.some(response => {
                        const responseType = response.substring(9); // Remove 'response:' prefix
                        return email.analysis?.response_required === responseType;
                    });
                    if (!matchesResponse) return false;
                }

                // Check category filters
                if (activeFilters.category.length > 0) {
                    const matchesCategory = activeFilters.category.some(category => {
                        const categoryName = category.substring(15); // Remove 'topic-category:' prefix
                        return email.analysis?.topic_category === categoryName;
                    });
                    if (!matchesCategory) return false;
                }

                // Check topic filters
                if (activeFilters.topics.length > 0) {
                    const matchesTopic = activeFilters.topics.some(topicFilter => {
                        const topic = topicFilter.substring(6).toLowerCase(); // Remove 'topic:' prefix

                        // Check in specific_topics
                        if (email.analysis?.specific_topics) {
                            const hasTopicInSpecific = email.analysis.specific_topics.some(t =>
                                t.toLowerCase().includes(topic) || topic.includes(t.toLowerCase())
                            );
                            if (hasTopicInSpecific) return true;
                        }

                        // Check in topic_category
                        if (email.analysis?.topic_category && email.analysis.topic_category.toLowerCase().includes(topic)) {
                            return true;
                        }

                        // Search in subject and body
                        if (email.subject && email.subject.toLowerCase().includes(topic)) {
                            return true;
                        }

                        const emailContent = (email.clean_text || email.body || '').toLowerCase();
                        if (emailContent.includes(topic)) {
                            return true;
                        }

                        return false;
                    });
                    if (!matchesTopic) return false;
                }

                return true;
            });

            // Sort by priority score (highest first)
            filtered.sort((a, b) => {
                const scoreA = a.analysis?.priority_score || 0;
                const scoreB = b.analysis?.priority_score || 0;
                return scoreB - scoreA;
            });

            // Display filtered results
            if (filtered.length === 0) {
                emailList.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #605e5c;">
                    <i class="fas fa-search" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                    <p style="font-size: 16px;">No emails match the selected filters</p>
                    <p style="font-size: 14px; margin-top: 8px;">Try removing some filters to see more results</p>
                    <button class="filter-chip" onclick="clearAllFilters()" style="margin-top: 16px;">
                        Clear All Filters
                    </button>
                </div>
            `;
                return;
            }

            // Display active filter summary
            const activeFilterCount = Object.values(activeFilters).reduce((sum, arr) => sum + arr.length, 0);
            const filterSummary = document.createElement('div');
            filterSummary.style.cssText = 'padding: 12px 16px; background: #f3f2f1; font-size: 13px; color: #605e5c;';
            filterSummary.innerHTML = `
            Showing ${filtered.length} email${filtered.length !== 1 ? 's' : ''} matching ${activeFilterCount} filter${activeFilterCount !== 1 ? 's' : ''}
            <button onclick="clearAllFilters()" style="margin-left: 8px; padding: 2px 8px; border: 1px solid #edebe9; border-radius: 12px; background: white; font-size: 11px; cursor: pointer;">Clear</button>
        `;
            emailList.appendChild(filterSummary);

            // Display emails
            filtered.forEach((email, index) => {
                const emailDiv = createEmailListItem(email, emailData.emails.indexOf(email));
                emailList.appendChild(emailDiv);
            });
        }

        function clearAllFilters() {
            activeFilters = {
                sentiment: [],
                priority: [],
                response: [],
                category: [],
                topics: []
            };

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });

            const allFilter = document.querySelector('.filter-chip[onclick*="all"]');
            if (allFilter) allFilter.classList.add('active');

            displayEmails('all');
        }

        function displayEmails(filter) {
            if (filter === 'all') {
                const emailList = document.getElementById('emailList');
                emailList.innerHTML = '';

                // Sort by priority score (highest first)
                const sorted = [...emailData.emails].sort((a, b) => {
                    const scoreA = a.analysis?.priority_score || 0;
                    const scoreB = b.analysis?.priority_score || 0;
                    return scoreB - scoreA;
                });

                sorted.forEach((email, index) => {
                    const emailDiv = createEmailListItem(email, emailData.emails.indexOf(email));
                    emailList.appendChild(emailDiv);
                });
            }
        }

        function selectEmail(email) {
            selectedEmail = email;

            // Update selection state
            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Show email detail
            document.getElementById('emptyDetail').style.display = 'none';
            document.getElementById('emailDetail').style.display = 'block';

            displayEmailDetail(email);
        }

        function displayEmailDetail(email) {
            // Validate email data
            if (!email) {
                console.error('Email data is null or undefined in displayEmailDetail');
                return;
            }

            if (!email.sender) {
                console.error('Email sender is missing:', email);
                // Try to provide a fallback
                email.sender = 'unknown@example.com';
            }

            // Set current email data for AI context
            window.currentEmailData = email;

            const senderName = extractNameFromEmail(email.sender);
            const formattedDate = email.date ?
                new Date(email.date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) :
                new Date().toLocaleDateString();

            // Get analysis data
            const analysis = email.analysis || {};
            const priorityScore = analysis.priority_score || 0;
            let priorityLevel = 'low';
            if (priorityScore >= 6) priorityLevel = 'high';
            else if (priorityScore >= 3) priorityLevel = 'medium';

            // Create badges
            let badges = '';
            if (analysis.sentiment?.ai_analysis) {
                const sentiment = analysis.sentiment.ai_analysis.overall_sentiment;
                badges += `<span class="sentiment-badge sentiment-${sentiment}">${sentiment}</span>`;
            }
            if (analysis.urgency?.level) {
                badges += `<span class="sentiment-badge sentiment-${analysis.urgency.level === 'critical' ? 'angry' : 'political'}">${analysis.urgency.level}</span>`;
            }
            badges += `<span class="priority-score ${priorityLevel}">Priority: ${priorityScore.toFixed(1)}</span>`;

            // Action items
            let actionItemsHtml = '';
            if (analysis.action_required?.items?.length > 0) {
                actionItemsHtml = `
                <div style="margin-top: 24px; padding: 16px; background: #faf9f8; border-radius: 8px;">
                    <h4 style="margin-bottom: 12px; color: #323130;">
                        <i class="fas fa-tasks"></i> Action Items
                    </h4>
                    ${analysis.action_required.items.map(item => `
                        <div style="padding: 8px 0; border-bottom: 1px solid #edebe9;">
                            <div style="font-weight: 500; margin-bottom: 4px;">${item.action}</div>
                            <div style="font-size: 12px; color: #605e5c;">
                                <span class="priority-indicator priority-${item.priority}"></span>
                                ${item.priority} priority
                                ${item.deadline ? `  Due: ${item.deadline}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            }

            // AI Insights
            let aiInsightsHtml = '';
            if (analysis.ai_insights) {
                const insights = analysis.ai_insights;
                aiInsightsHtml = `
                <div style="margin-top: 24px; padding: 16px; background: #f3e5f5; border-radius: 8px;">
                    <h4 style="margin-bottom: 12px; color: #5c2d91;">
                        <i class="fas fa-brain"></i> AI Analysis
                    </h4>
                    <p style="margin-bottom: 12px;">${insights.executive_summary}</p>
                    ${insights.suggested_response ? `
                        <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 4px;">
                            <strong>Suggested Response:</strong><br>
                            ${insights.suggested_response}
                        </div>
                    ` : ''}
                </div>
            `;
            }

            // Sender insights
            let senderInsightsHtml = '';
            if (emailData.summary?.sender_analysis?.[email.sender]) {
                const senderData = emailData.summary.sender_analysis[email.sender];
                senderInsightsHtml = `
                <div class="sender-insights">
                    <h4 style="margin-bottom: 12px;">
                        <i class="fas fa-user"></i> Sender Insights
                    </h4>
                    <div class="sender-stat">
                        <span class="sender-stat-label">Total emails from sender:</span>
                        <span class="sender-stat-value">${senderData.count}</span>
                    </div>
                    <div class="sender-stat">
                        <span class="sender-stat-label">Average priority:</span>
                        <span class="sender-stat-value">${senderData.avg_priority.toFixed(1)}</span>
                    </div>
                    <div class="sender-stat">
                        <span class="sender-stat-label">Top topics:</span>
                        <span class="sender-stat-value">${senderData.top_topics.join(', ')}</span>
                    </div>
                </div>
            `;
            }

            // Format body content with proper handling of line breaks
            let bodyContent = '';

            // Helper function to properly convert escaped newlines to HTML
            function processTextContent(text) {
                if (!text) return '';

                // First, replace literal backslash-r-backslash-n sequences
                let processed = text
                    .replace(/\\r\\n/g, '\n')  // Convert \r\n to newline
                    .replace(/\\n/g, '\n')      // Convert \n to newline
                    .replace(/\\r/g, '\n')      // Convert \r to newline
                    .replace(/\\t/g, '    ');   // Convert tabs to spaces

                // Handle multiple consecutive newlines (preserve paragraph breaks)
                processed = processed
                    .split('\n')
                    .map(line => line.trim())
                    .join('\n');

                // Convert single newlines to <br> and double newlines to paragraph breaks
                processed = processed
                    .replace(/\n\n+/g, '</p><p style="margin: 16px 0;">')  // Paragraph breaks
                    .replace(/\n/g, '<br>');                                // Line breaks

                // Wrap in paragraph tags
                processed = `<p style="margin: 0;">${processed}</p>`;

                // Clean up empty paragraphs
                processed = processed.replace(/<p[^>]*>\s*<\/p>/g, '');

                return processed;
            }

            if (email.body) {
                // Check if this is plain text or HTML
                const hasHtmlTags = /<[a-zA-Z][^>]*>/.test(email.body);

                if (!hasHtmlTags || email.body.includes('\\r\\n') || email.body.includes('\\n')) {
                    // This is plain text or has escaped newlines - process it
                    const processedBody = processTextContent(email.body);

                    bodyContent = `
                    <div style="font-size: 14px; line-height: 1.8; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #323130; word-wrap: break-word;">
                        ${processedBody}
                    </div>
                `;
                } else {
                    // This is HTML content - use iframe
                    bodyContent = `
                    <iframe 
                        id="emailFrame" 
                        style="width: 100%; border: none; min-height: 600px;" 
                        sandbox="allow-same-origin"
                    ></iframe>
                `;
                }
            } else if (email.clean_text) {
                // Process clean_text with proper line break handling
                const processedContent = processTextContent(email.clean_text);

                bodyContent = `
                <div style="font-size: 14px; line-height: 1.8; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #323130; word-wrap: break-word;">
                    ${processedContent}
                </div>
            `;
            } else {
                bodyContent = '<div style="color: #605e5c; font-style: italic;">Unable to display email content</div>';
            }

            document.getElementById('emailContent').innerHTML = `
            <div style="margin-bottom: 24px;" id="email-content-header">
                <h2 style="margin-bottom: 8px;">${email.subject}</h2>
                <div style="display: flex; flex-direction: column; gap: 8px; color: #605e5c; font-size: 14px;">
                    <div><strong>From:</strong> ${senderName} &lt;${email.sender}&gt;</div>
                    <div><strong>Date:</strong> ${formattedDate}</div>
                </div>
                <div style="margin-top: 8px;">${badges}</div>
            </div>
            ${aiInsightsHtml}
            ${actionItemsHtml}
            ${senderInsightsHtml}
            <div style="margin-top: 24px;">
                <h4 style="margin-bottom: 12px;">Email Content</h4>
                ${bodyContent}
            </div>
        `;

            // If using iframe for HTML emails, write the content
            if (email.body && bodyContent.includes('iframe')) {
                setTimeout(() => {
                    const iframe = document.getElementById('emailFrame');
                    if (!iframe) return;

                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                    // Write the HTML content
                    iframeDoc.open();
                    iframeDoc.write(email.body);
                    iframeDoc.close();

                    // Adjust iframe height
                    const adjustHeight = () => {
                        try {
                            const height = Math.max(
                                iframeDoc.body.scrollHeight,
                                iframeDoc.documentElement.scrollHeight,
                                600
                            );
                            iframe.style.height = height + 'px';
                        } catch (e) {
                            iframe.style.height = '600px';
                        }
                    };

                    iframe.onload = adjustHeight;
                    setTimeout(adjustHeight, 200);
                }, 0);
            }
        }

        function filterByUrgency(urgency, element) {
            currentFilter = urgency;

            // Update active state
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            element.classList.add('active');

            displayEmails(urgency);
        }

        function filterByTopicFromBadge(topic) {
            // Find and click the corresponding topic filter chip
            const topicChips = document.querySelectorAll('.filter-chip');
            let found = false;

            topicChips.forEach(chip => {
                if (chip.textContent.toLowerCase().includes(topic.toLowerCase())) {
                    chip.click();
                    found = true;
                }
            });

            // If not found in current filter chips, create a temporary filter
            if (!found) {
                currentFilter = 'topic:' + topic;
                displayEmails(currentFilter);

                // Update filter bar to show current topic
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                });
            }
        }

        function createTopicFilters(topics) {
            // Get top topics (e.g., top 10 by frequency)
            topTopicsList = Object.entries(topics)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([topic, count]) => ({ topic, count }));

            console.log('Top topics:', topTopicsList);

            // Find the dynamic topic filters container
            const dynamicContainer = document.getElementById('dynamicTopicFilters');

            if (topTopicsList.length > 0) {
                // Clear existing content
                dynamicContainer.innerHTML = '';

                // Add topic label
                const topicLabel = document.createElement('span');
                topicLabel.className = 'filter-category-label';
                topicLabel.textContent = 'TOPICS:';
                dynamicContainer.appendChild(topicLabel);

                // Add topic chips
                topTopicsList.forEach(({ topic, count }) => {
                    const chip = document.createElement('div');
                    chip.className = 'filter-chip topic-filter-chip';
                    chip.innerHTML = `${topic} <span style="opacity: 0.6; font-size: 10px;">(${count})</span>`;
                    chip.onclick = function () { filterByTopic(topic, this); };
                    dynamicContainer.appendChild(chip);
                });
            }
        }

        function searchEmails() {
            const query = document.getElementById('searchBox').value.toLowerCase();

            // First apply active filters
            const hasActiveFilters = Object.values(activeFilters).some(arr => arr.length > 0);
            let baseEmails = emailData.emails;

            if (hasActiveFilters) {
                // Apply the same filter logic as in applyFilters
                baseEmails = emailData.emails.filter(email => {
                    // Check sentiment filters
                    if (activeFilters.sentiment.length > 0) {
                        const matchesSentiment = activeFilters.sentiment.some(sentiment => {
                            if (email.analysis?.sentiment_category === sentiment) return true;
                            if (email.analysis?.sentiment?.ai_analysis?.overall_sentiment === sentiment) return true;
                            if (email.analysis?.sentiment?.classification === sentiment) return true;
                            return false;
                        });
                        if (!matchesSentiment) return false;
                    }

                    // Check priority filters
                    if (activeFilters.priority.length > 0) {
                        const priorityScore = email.analysis?.priority_score || 0;
                        const matchesPriority = activeFilters.priority.some(priority => {
                            switch (priority) {
                                case 'critical': return priorityScore >= 9;
                                case 'high': return priorityScore >= 7 && priorityScore < 9;
                                case 'medium': return priorityScore >= 5 && priorityScore < 7;
                                case 'low': return priorityScore >= 1 && priorityScore < 5;
                                default: return false;
                            }
                        });
                        if (!matchesPriority) return false;
                    }

                    // Check response filters
                    if (activeFilters.response.length > 0) {
                        const matchesResponse = activeFilters.response.some(response => {
                            const responseType = response.substring(9);
                            return email.analysis?.response_required === responseType;
                        });
                        if (!matchesResponse) return false;
                    }

                    // Check category filters
                    if (activeFilters.category.length > 0) {
                        const matchesCategory = activeFilters.category.some(category => {
                            const categoryName = category.substring(15);
                            return email.analysis?.topic_category === categoryName;
                        });
                        if (!matchesCategory) return false;
                    }

                    // Check topic filters
                    if (activeFilters.topics.length > 0) {
                        const matchesTopic = activeFilters.topics.some(topicFilter => {
                            const topic = topicFilter.substring(6).toLowerCase();

                            if (email.analysis?.specific_topics) {
                                const hasTopicInSpecific = email.analysis.specific_topics.some(t =>
                                    t.toLowerCase().includes(topic) || topic.includes(t.toLowerCase())
                                );
                                if (hasTopicInSpecific) return true;
                            }

                            if (email.analysis?.topic_category && email.analysis.topic_category.toLowerCase().includes(topic)) {
                                return true;
                            }

                            if (email.subject && email.subject.toLowerCase().includes(topic)) {
                                return true;
                            }

                            const emailContent = (email.clean_text || email.body || '').toLowerCase();
                            if (emailContent.includes(topic)) {
                                return true;
                            }

                            return false;
                        });
                        if (!matchesTopic) return false;
                    }

                    return true;
                });
            }

            // Then apply search
            const filtered = baseEmails.filter(email => {
                const senderName = extractNameFromEmail(email.sender).toLowerCase();
                const summary = email.analysis?.summary?.toLowerCase() || '';
                const cleanText = email.clean_text?.toLowerCase() || '';
                const topics = email.analysis?.topics?.map(t => t.toLowerCase()).join(' ') || '';

                return senderName.includes(query) ||
                    email.sender.toLowerCase().includes(query) ||
                    email.subject.toLowerCase().includes(query) ||
                    summary.includes(query) ||
                    cleanText.includes(query) ||
                    topics.includes(query);
            });

            const emailList = document.getElementById('emailList');
            emailList.innerHTML = '';

            if (filtered.length === 0) {
                emailList.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #605e5c;">
                    <i class="fas fa-search" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                    <p style="font-size: 16px;">No emails found matching "${query}"</p>
                </div>
            `;
                return;
            }

            filtered.forEach((email, index) => {
                const emailDiv = createEmailListItem(email, emailData.emails.indexOf(email));
                emailList.appendChild(emailDiv);
            });
        }

        function showView(view) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');

            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Show selected view
            currentView = view;
            if (view === 'emails') {
                document.getElementById('emailView').style.display = 'flex';
            } else if (view === 'priority') {
                document.getElementById('priorityView').style.display = 'block';
                displayPriorityEmails();
            } else if (view === 'actions') {
                document.getElementById('actionsView').style.display = 'block';
                displayActionItems();
            } else if (view === 'dashboard') {
                document.getElementById('dashboardView').style.display = 'block';
            } else if (view === 'insights') {
                document.getElementById('insightsView').style.display = 'block';
            }
        }

        function displayPriorityEmails() {
            const container = document.getElementById('priorityEmailsList');
            container.innerHTML = '';

            // Group emails by priority
            const highPriority = emailData.emails.filter(e => e.analysis?.priority_score >= 6);
            const mediumPriority = emailData.emails.filter(e =>
                e.analysis?.priority_score >= 3 && e.analysis?.priority_score < 6
            );
            const lowPriority = emailData.emails.filter(e =>
                e.analysis?.priority_score < 3 && e.analysis?.priority_score > 0
            );

            // Create sections
            if (highPriority.length > 0) {
                container.innerHTML += `
                <div style="margin-bottom: 32px;">
                    <h3 style="color: #d13438; margin-bottom: 16px;">
                        <span class="priority-indicator priority-high"></span>
                        High Priority (${highPriority.length})
                    </h3>
                    <div class="priority-emails-group">
                        ${highPriority.map(email => createPriorityEmailCard(email)).join('')}
                    </div>
                </div>
            `;
            }

            if (mediumPriority.length > 0) {
                container.innerHTML += `
                <div style="margin-bottom: 32px;">
                    <h3 style="color: #ffb900; margin-bottom: 16px;">
                        <span class="priority-indicator priority-medium"></span>
                        Medium Priority (${mediumPriority.length})
                    </h3>
                    <div class="priority-emails-group">
                        ${mediumPriority.map(email => createPriorityEmailCard(email)).join('')}
                    </div>
                </div>
            `;
            }

            if (lowPriority.length > 0) {
                container.innerHTML += `
                <div style="margin-bottom: 32px;">
                    <h3 style="color: #10c510; margin-bottom: 16px;">
                        <span class="priority-indicator priority-low"></span>
                        Low Priority (${lowPriority.length})
                    </h3>
                    <div class="priority-emails-group">
                        ${lowPriority.map(email => createPriorityEmailCard(email)).join('')}
                    </div>
                </div>
            `;
            }
        }

        function createPriorityEmailCard(email) {
            const senderName = extractNameFromEmail(email.sender);
            const analysis = email.analysis || {};
            const priorityScore = analysis.priority_score || 0;

            return `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"
                 onclick="selectEmailFromPriority(${emailData.emails.indexOf(email)})"
                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                        <h4 style="margin: 0 0 4px 0;">${email.subject}</h4>
                        <div style="color: #605e5c; font-size: 14px;">From: ${senderName}</div>
                    </div>
                    <div style="font-size: 24px; font-weight: 600; color: ${priorityScore >= 6 ? '#d13438' : priorityScore >= 3 ? '#ffb900' : '#10c510'};">
                        ${priorityScore.toFixed(1)}
                    </div>
                </div>
                <p style="margin: 12px 0; font-size: 14px; color: #605e5c; line-height: 1.5;">
                    ${analysis.summary || 'No summary available'}
                </p>
                ${analysis.action_required?.items?.length > 0 ? `
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #edebe9;">
                        <strong style="font-size: 13px;">Actions Required:</strong>
                        <ul style="margin: 8px 0 0 20px; font-size: 13px; color: #605e5c;">
                            ${analysis.action_required.items.slice(0, 2).map(item =>
                `<li>${item.action}</li>`
            ).join('')}
                            ${analysis.action_required.items.length > 2 ?
                        `<li>...and ${analysis.action_required.items.length - 2} more</li>` : ''
                    }
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;
        }

        function selectEmailFromPriority(emailIndex) {
            showView('emails');
            setTimeout(() => {
                const email = emailData.emails[emailIndex];
                selectEmail(email);

                // Scroll to email in list
                const emailItems = document.querySelectorAll('.email-item');
                emailItems.forEach(item => {
                    if (parseInt(item.getAttribute('data-email-index')) === emailIndex) {
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 100);
        }

        function filterPriority(level, element) {
            // Update active state
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            element.classList.add('active');

            if (level === 'all') {
                displayPriorityEmails();
            } else {
                const container = document.getElementById('priorityEmailsList');
                container.innerHTML = '';

                let filtered = [];
                if (level === 'high') {
                    filtered = emailData.emails.filter(e => e.analysis?.priority_score >= 6);
                } else if (level === 'medium') {
                    filtered = emailData.emails.filter(e =>
                        e.analysis?.priority_score >= 3 && e.analysis?.priority_score < 6
                    );
                } else if (level === 'low') {
                    filtered = emailData.emails.filter(e =>
                        e.analysis?.priority_score < 3 && e.analysis?.priority_score > 0
                    );
                }

                container.innerHTML = `
                <div class="priority-emails-group">
                    ${filtered.map(email => createPriorityEmailCard(email)).join('')}
                </div>
            `;
            }
        }

        async function displayActionItems() {
            try {
                const response = await fetch(`${API_BASE_URL}/action-items`);
                const data = await response.json();

                const container = document.getElementById('actionItemsList');
                container.innerHTML = '';

                // Display summary
                if (emailData.summary?.ai_insights?.action_items) {
                    const summaryDiv = document.getElementById('actionSummary');
                    summaryDiv.innerHTML = `
                    <p style="margin-bottom: 16px;">${emailData.summary.ai_insights.executive_summary}</p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #d13438;">
                                ${data.actionItems.filter(a => a.priority === 'high').length}
                            </div>
                            <div style="font-size: 12px; color: #605e5c;">High Priority</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #ffb900;">
                                ${data.actionItems.filter(a => a.priority === 'medium').length}
                            </div>
                            <div style="font-size: 12px; color: #605e5c;">Medium Priority</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #10c510;">
                                ${data.actionItems.filter(a => a.priority === 'low').length}
                            </div>
                            <div style="font-size: 12px; color: #605e5c;">Low Priority</div>
                        </div>
                    </div>
                `;
                }

                // Display action items
                data.actionItems.forEach((item, index) => {
                    const actionDiv = document.createElement('div');
                    actionDiv.className = 'action-item';

                    actionDiv.innerHTML = `
                    <input type="checkbox" class="action-checkbox" id="action-${index}">
                    <div class="action-content">
                        <label for="action-${index}" class="action-text">${item.action}</label>
                        <div class="action-meta">
                            <span class="priority-indicator priority-${item.priority}"></span>
                            <span>${item.priority} priority</span>
                            <span style="margin: 0 8px;"></span>
                            <span>From: "${item.emailSubject}"</span>
                            ${item.deadline ? `
                                <span class="action-deadline">
                                    <i class="fas fa-calendar"></i>
                                    ${item.deadline}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;

                    actionDiv.onclick = (e) => {
                        if (e.target.type !== 'checkbox') {
                            selectEmailFromPriority(item.emailId);
                        }
                    };

                    container.appendChild(actionDiv);
                });
            } catch (error) {
                console.error('Error loading action items:', error);
            }
        }

        function displayAIInsights(stats) {
            if (!stats.aiInsights) return;

            const insights = stats.aiInsights;

            // Executive Summary
            document.getElementById('executiveSummary').innerHTML = insights.executive_summary;

            // Key Points
            const keyPointsList = document.getElementById('keyPoints');
            keyPointsList.innerHTML = insights.key_points.map(point =>
                `<li>${point}</li>`
            ).join('');

            // Risks
            const risksList = document.getElementById('risksList');
            risksList.innerHTML = insights.risks.map(risk =>
                `<li>${risk}</li>`
            ).join('');

            // Opportunities
            const opportunitiesList = document.getElementById('opportunitiesList');
            opportunitiesList.innerHTML = insights.opportunities.map(opp =>
                `<li>${opp}</li>`
            ).join('');

            // Stakeholders
            const stakeholdersList = document.getElementById('stakeholdersList');
            stakeholdersList.innerHTML = insights.stakeholders.map(stakeholder =>
                `<span class="member-badge" style="font-size: 14px; padding: 6px 12px;">${stakeholder}</span>`
            ).join('');
        }

        function toggleAIPanel() {
            const panel = document.getElementById('aiPanel');
            const toggleBtn = document.getElementById('aiToggleBtn');
            const detailPanel = document.getElementById('detailPanel');

            aiPanelOpen = !aiPanelOpen;

            if (aiPanelOpen) {
                panel.classList.add('open');
                detailPanel.classList.add('ai-open');
                toggleBtn.classList.add('active');
            } else {
                panel.classList.remove('open');
                detailPanel.classList.remove('ai-open');
                toggleBtn.classList.remove('active');
            }
        }

        function askSuggestion(question) {
            const input = document.getElementById('aiChatInput');
            input.value = question;
            sendAIMessage();
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const container = document.getElementById('aiChatContainer');

            const message = input.value.trim();
            if (!message) return;

            // Add user message
            container.innerHTML += `
            <div class="message user">
                <div class="message-avatar">U</div>
                <div class="message-content">${message}</div>
            </div>
        `;

            input.value = '';

            // Add loading indicator
            const loadingId = 'loading-' + Date.now();
            container.innerHTML += `
            <div class="message" id="${loadingId}">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <i class="fas fa-spinner fa-spin"></i> Analyzing with deep AI insights...
                </div>
            </div>
        `;

            container.scrollTop = container.scrollHeight;

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                // Remove loading indicator
                document.getElementById(loadingId).remove();

                // Add AI response
                container.innerHTML += `
                <div class="message">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">${data.response.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            } catch (error) {
                document.getElementById(loadingId).remove();
                container.innerHTML += `
                <div class="message">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">Sorry, I couldn't process that request. Please check your connection.</div>
                </div>
            `;
            }

            container.scrollTop = container.scrollHeight;
        }

        function initCharts(stats) {
            // Sentiment Chart
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            charts.sentiment = new Chart(sentimentCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.sentiments || {}),
                    datasets: [{
                        data: Object.values(stats.sentiments || {}),
                        backgroundColor: [
                            '#0b7209', // positive
                            '#a4262c', // negative
                            '#ffb900', // mixed
                            '#004578', // neutral
                            '#5c2d91', // concerned
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 14 }
                            }
                        }
                    }
                }
            });

            // Urgency Chart
            const urgencyCtx = document.getElementById('urgencyChart').getContext('2d');
            charts.urgency = new Chart(urgencyCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.urgency || {}),
                    datasets: [{
                        label: 'Emails',
                        data: Object.values(stats.urgency || {}),
                        backgroundColor: ['#10c510', '#ffb900', '#d13438']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { font: { size: 14 } }
                        },
                        x: {
                            ticks: { font: { size: 14 } }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Topics Chart
            const topTopics = Object.entries(stats.topics || {})
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const topicsCtx = document.getElementById('topicsChart').getContext('2d');
            charts.topics = new Chart(topicsCtx, {
                type: 'bar',
                data: {
                    labels: topTopics.map(t => t[0]),
                    datasets: [{
                        label: 'Mentions',
                        data: topTopics.map(t => t[1]),
                        backgroundColor: '#5c2d91'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { font: { size: 12 } }
                        },
                        y: {
                            ticks: { font: { size: 12 } }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Top Senders Chart
            const topSenders = Object.entries(stats.senderAnalysis || {})
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);

            const sendersCtx = document.getElementById('sendersChart').getContext('2d');
            charts.senders = new Chart(sendersCtx, {
                type: 'bar',
                data: {
                    labels: topSenders.map(s => extractNameFromEmail(s[0])),
                    datasets: [{
                        label: 'Emails',
                        data: topSenders.map(s => s[1].count),
                        backgroundColor: '#0078d4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { font: { size: 14 } }
                        },
                        x: {
                            ticks: { font: { size: 12 } }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function addTopicOverviewToDashboard() {
            const dashboardView = document.getElementById('dashboardView');
            const chartGrid = dashboardView.querySelector('.chart-grid');

            if (topTopicsList.length === 0) return;

            // Check if topic section already exists
            if (dashboardView.querySelector('.topic-filter-section')) {
                return;
            }

            // Create topic overview section
            const topicSection = document.createElement('div');
            topicSection.className = 'topic-filter-section';
            topicSection.innerHTML = `
            <h3 class="chart-title">Browse by Topic</h3>
            <div class="topic-grid" id="topicGrid">
                ${topTopicsList.map(({ topic, count }) => `
                    <div class="topic-card" onclick="navigateToTopic('${topic}')">
                        <div class="topic-card-name">${topic}</div>
                        <div class="topic-card-count">${count}</div>
                        <div style="font-size: 12px; color: #605e5c;">emails</div>
                    </div>
                `).join('')}
            </div>
        `;

            // Insert before the chart grid
            dashboardView.insertBefore(topicSection, chartGrid);
        }

        function navigateToTopic(topic) {
            // Switch to email view
            const emailNavItem = document.querySelector('.nav-item[onclick*="emails"]');
            if (emailNavItem) {
                emailNavItem.click();
            }

            // Clear existing filters and apply only this topic
            setTimeout(() => {
                clearAllFilters();
                filterByTopic(topic, null);

                // Find and activate the topic chip
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    if (chip.textContent.includes(topic)) {
                        chip.classList.add('active');
                    }
                });
            }, 100);
        }

        // Add these new functions to your existing script

        function initializeFilterBar() {
            // Create the toggle button and active filters summary
            const filterBar = document.querySelector('.filter-bar');

            // Add click handler to the entire filter bar
            filterBar.onclick = function (e) {
                // Don't toggle if clicking on interactive elements
                if (e.target.classList.contains('filter-chip') ||
                    e.target.classList.contains('remove-filter') ||
                    e.target.classList.contains('summary-clear-btn') ||
                    e.target.closest('.filter-chip') ||
                    e.target.closest('.active-filter-pill')) {
                    return;
                }
                toggleFilterBar();
            };

            // Add toggle icon (no longer a button)
            const toggleIcon = document.createElement('div');
            toggleIcon.className = 'filter-toggle';
            toggleIcon.innerHTML = '<i class="fas fa-chevron-up"></i> <span>Filters</span>';

            // Add active filters summary container
            const summaryContainer = document.createElement('div');
            summaryContainer.className = 'active-filters-summary';
            summaryContainer.id = 'activeFiltersSummary';

            // Wrap existing filter content
            const filterContent = document.createElement('div');
            filterContent.className = 'filter-content';

            // Move all filter rows into the content wrapper
            const filterRows = filterBar.querySelectorAll('.filter-row');
            filterRows.forEach(row => {
                filterContent.appendChild(row);
            });

            // Clear and rebuild filter bar
            filterBar.innerHTML = '';
            filterBar.appendChild(toggleIcon);
            filterBar.appendChild(summaryContainer);
            filterBar.appendChild(filterContent);

            // Check if there are active filters on load
            updateActiveFiltersSummary();
        }

        function toggleFilterBar() {
            const filterBar = document.querySelector('.filter-bar');
            filterBar.classList.toggle('collapsed');

            // Update icon text
            const toggleIcon = filterBar.querySelector('.filter-toggle span');
            const isCollapsed = filterBar.classList.contains('collapsed');
            toggleIcon.textContent = isCollapsed ? 'Show Filters' : 'Filters';

            // Save preference to localStorage
            localStorage.setItem('filterBarCollapsed', isCollapsed);
        }

        function updateActiveFiltersSummary() {
            const summaryContainer = document.getElementById('activeFiltersSummary');
            if (!summaryContainer) return;

            summaryContainer.innerHTML = '';

            const activeFilterCount = Object.values(activeFilters).reduce((sum, arr) => sum + arr.length, 0);

            if (activeFilterCount === 0) {
                summaryContainer.innerHTML = '<span class="filter-summary-text">No active filters</span>';
                return;
            }

            // Add count
            summaryContainer.innerHTML = `<span class="filter-summary-text">${activeFilterCount} active filter${activeFilterCount !== 1 ? 's' : ''}:</span>`;

            // Add filter pills
            Object.entries(activeFilters).forEach(([filterType, filters]) => {
                filters.forEach(filter => {
                    const pill = document.createElement('span');
                    pill.className = 'active-filter-pill';

                    let displayName = filter;
                    if (filter.startsWith('response:')) {
                        displayName = filter.substring(9);
                    } else if (filter.startsWith('topic-category:')) {
                        displayName = filter.substring(15);
                    } else if (filter.startsWith('topic:')) {
                        displayName = filter.substring(6);
                    }

                    pill.innerHTML = `
                ${displayName}
                <span class="remove-filter" onclick="removeFilterFromSummary('${filterType}', '${filter}')">&times;</span>
            `;
                    summaryContainer.appendChild(pill);
                });
            });

            // Add clear all button
            const clearBtn = document.createElement('button');
            clearBtn.className = 'summary-clear-btn';
            clearBtn.textContent = 'Clear All';
            clearBtn.onclick = function (e) {
                e.stopPropagation(); // Prevent filter bar toggle
                clearAllFilters();
            };
            summaryContainer.appendChild(clearBtn);
        }

        function removeFilterFromSummary(filterType, filterValue) {
            event.stopPropagation(); // Prevent filter bar toggle

            // Find and remove the filter
            const index = activeFilters[filterType].indexOf(filterValue);
            if (index > -1) {
                activeFilters[filterType].splice(index, 1);
            }

            // Update UI
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });

            // Re-activate remaining filters
            Object.entries(activeFilters).forEach(([type, filters]) => {
                filters.forEach(filter => {
                    document.querySelectorAll('.filter-chip').forEach(chip => {
                        if (chip.textContent.includes(filter.replace('response:', '').replace('topic-category:', '').replace('topic:', ''))) {
                            chip.classList.add('active');
                        }
                    });
                });
            });

            // Deactivate preset buttons since filter has been modified
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Update summary and apply filters
            updateActiveFiltersSummary();
            applyFilters();
        }

        // Modify your existing toggleFilter function to include summary update and preset deactivation
        const originalToggleFilter = toggleFilter;
        window.toggleFilter = function (filterType, filterValue, element) {
            originalToggleFilter(filterType, filterValue, element);
            updateActiveFiltersSummary();

            // Deactivate preset buttons since filter has been modified
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        };

        // Modify your existing clearAllFilters function to include summary update
        const originalClearAllFilters = clearAllFilters;
        window.clearAllFilters = function () {
            originalClearAllFilters();

            // Clear preset button states
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            updateActiveFiltersSummary();
        };

        // Update window.onload to initialize the collapsible filter bar
        const originalOnload = window.onload;
        window.onload = async function () {
            await originalOnload();

            // Initialize collapsible filter bar
            setTimeout(() => {
                initializeFilterBar();
                initializePresetFilters();

                // Restore collapsed state from localStorage
                const isCollapsed = localStorage.getItem('filterBarCollapsed') === 'true';
                if (isCollapsed) {
                    document.querySelector('.filter-bar').classList.add('collapsed');
                    const toggleIcon = document.querySelector('.filter-toggle span');
                    toggleIcon.textContent = 'Show Filters';
                }
            }, 100);
        };

        // Add preset filter functionality
        function initializePresetFilters() {
            const filterBar = document.querySelector('.filter-bar');

            // Create preset filters container
            const presetContainer = document.createElement('div');
            presetContainer.className = 'preset-filters';
            presetContainer.innerHTML = `
        <span class="preset-label">Quick Filters:</span>
        <button class="preset-btn" onclick="applyPresetFilter('urgent-political')">
            <i class="fas fa-exclamation-triangle"></i>
            Critical + Political
        </button>
        <button class="preset-btn" onclick="applyPresetFilter('urgent-action')">
            <i class="fas fa-fire"></i>
            Critical + Political + Direct Response
        </button>
        <div class="preset-divider"></div>
        <button class="preset-btn" onclick="applyPresetFilter('high-priority-members')">
            <i class="fas fa-user-shield"></i>
            High Priority + Membership
        </button>
        <button class="preset-btn" onclick="applyPresetFilter('complaints-leadership')">
            <i class="fas fa-comments"></i>
            Complaints + Leadership
        </button>
    `;

            // Insert after filter bar
            filterBar.parentNode.insertBefore(presetContainer, filterBar.nextSibling);
        }

        function applyPresetFilter(preset) {
            // Clear all existing filters first
            clearAllFilters();

            // Define preset combinations
            const presets = {
                'urgent-political': {
                    priority: ['critical'],
                    category: ['topic-category:political']
                },
                'urgent-action': {
                    priority: ['critical'],
                    category: ['topic-category:political'],
                    response: ['response:yes-direct']
                },
                'high-priority-members': {
                    priority: ['high'],
                    category: ['topic-category:membership']
                },
                'complaints-leadership': {
                    sentiment: ['complaint'],
                    category: ['topic-category:leadership']
                }
            };

            const selectedPreset = presets[preset];
            if (!selectedPreset) return;

            // Store which preset is currently active
            window.activePreset = preset;

            // Apply the preset filters
            Object.entries(selectedPreset).forEach(([filterType, filterValues]) => {
                filterValues.forEach(filterValue => {
                    activeFilters[filterType].push(filterValue);

                    // Find and activate corresponding filter chips
                    document.querySelectorAll('.filter-chip').forEach(chip => {
                        const chipText = chip.textContent.toLowerCase();
                        const filterText = filterValue.replace('response:', '').replace('topic-category:', '').toLowerCase();

                        if (chipText.includes(filterText) ||
                            (filterValue === 'critical' && chipText.includes('critical')) ||
                            (filterValue === 'high' && chipText.includes('high') && !chipText.includes('critical')) ||
                            (filterValue === 'response:yes-direct' && chipText.includes('direct response'))) {
                            chip.classList.add('active');
                        }
                    });
                });
            });

            // Update preset button states
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.preset-btn').classList.add('active');

            // Apply filters and update summary
            updateActiveFiltersSummary();
            applyFilters();

            // Optionally collapse the filter bar after applying preset
            const filterBar = document.querySelector('.filter-bar');
            if (!filterBar.classList.contains('collapsed')) {
                toggleFilterBar();
            }
        }

        // AI Compose Modal Functions
        function openComposeModal(type = 'COMPOSE_WITH_AI') {
            // Set the current compose type globally
            window.currentComposeType = type;
            console.log('Setting currentComposeType to:', type);

            document.getElementById('composeModal').classList.add('active');

            const titleElement = document.getElementById('composeModalTitle');
            const composeInputSection = document.getElementById('composeInputView');
            const composeToneSection = document.querySelector('.compose-tone-section');

            const regenerateBtn = document.getElementById('regenerateBtn')

            if (type === 'COMPOSE_WITH_AI') {
                titleElement.textContent = `Compose with AI`;

                // Show compose sections for regular compose
                composeInputSection.style.display = 'block';
                composeToneSection.style.display = 'block';

                // Show Generate Draft and Regenerate buttons in compose mode
                document.querySelector('.generate-btn').style.display = 'inline-flex';
                regenerateBtn.innerText = 'Regenerate'
                regenerateBtn.style.display = 'none'; // Initially hidden until first draft is generated
                document.getElementById('replyInlineBtn').style.display = 'none'; // Hide Reply Inline in compose mode

                document.getElementById('composePrompt').focus();
            } else if (type === 'REPLY_WITH_AI') {
                titleElement.textContent = 'Reply with AI';

                // Hide the prompt input section for replies (we don't need user input)
                composeInputSection.style.display = 'none';
                composeToneSection.style.display = 'block';

                // Hide Generate Draft and Regenerate buttons in reply mode
                document.querySelector('.generate-btn').style.display = 'none';
                document.getElementById('regenerateBtn').style.display = 'none';

                // Show Reply Inline button for reply mode (initially hidden until draft is generated)
                document.getElementById('replyInlineBtn').style.display = 'none';

                // Show Inline reply
                document.getElementById('aiInlinModeSwitch').style.display = 'inline-flex';

                restructureComposeModal();

                // Automatically generate the reply
                setTimeout(() => {
                    generateAIReply();
                }, 500); // Small delay to let the modal fully open
            }
        }
        let modalInputView = document.querySelector('#composeInputView');
        function restructureComposeModal() {
            // Get elements
            const composeModal = document.getElementById("composeModal");
            const modalHeader = composeModal.querySelector(".compose-modal-header");
            const modalBody = composeModal.querySelector(".compose-modal-body");

            // Clone the email content
            const emailContentClone = cloneEmailContent();

            // Insert the clone after the header
            modalHeader.insertAdjacentElement('afterend', emailContentClone);

            if (modalBody.firstElementChild) modalBody.firstElementChild.remove();
            // Append the modal body inside the clone
            emailContentClone.appendChild(modalBody);
        }

        function cloneEmailContent() {
            const original = document.getElementById('emailContent');
            const clone = original.cloneNode(true);
            clone.classList.add('email-content-clone')

            const originalIframe = original.querySelector('iframe');
            console.log(originalIframe)
            const clonedIframe = clone.querySelector('iframe');

            if (originalIframe && clonedIframe) {
                try {
                    const originalDoc = originalIframe.contentDocument;
                    if (originalDoc) {
                        const iframeContent = originalDoc.documentElement.cloneNode(true);

                        // Wait for the cloned iframe to load
                        clonedIframe.addEventListener('load', () => {
                            try {
                                const clonedDoc = clonedIframe.contentDocument;
                                if (clonedDoc) {
                                    clonedDoc.open();
                                    clonedDoc.write('<!DOCTYPE html>' + iframeContent.outerHTML);
                                    clonedDoc.close();
                                }
                            } catch (err) {
                                console.warn('Error injecting into cloned iframe:', err);
                            }
                        });

                        // Force reload to trigger load event
                        clonedIframe.src = originalIframe.src;
                    }
                } catch (err) {
                    console.warn('Could not access iframe content (likely cross-origin):', err);
                }
            }

            return clone;
        }

        function resetComposeModalStructure() {
            const composeModal = document.getElementById("composeModal");
            const emailContentClone = composeModal.querySelector(".email-content-clone"); // Use a unique class or ID when cloning
            const modalBody = composeModal.querySelector(".compose-modal-body");

            modalBody.prepend(modalInputView)

            if (emailContentClone && modalBody) {
                // Move modalBody back to original parent (composeModal-content)
                const modalContent = composeModal.querySelector(".compose-modal-content");

                // Insert modalBody before compose-modal-footer
                const footer = modalContent.querySelector(".compose-modal-footer");
                modalContent.insertBefore(modalBody, footer);

                // Remove the cloned email content container
                emailContentClone.remove();
            }
        }

        function closeComposeModal() {
            resetComposeModalStructure()

            // Clear the current compose type
            window.currentComposeType = null;

            document.getElementById('composeModal').classList.remove('active');
            document.getElementById('composeModal').classList.remove('maximized');

            // Reset form
            document.getElementById('composePrompt').value = '';
            if (window.editorInstance) {
                window.editorInstance.html.set('');
            } else {
                const draftContent = document.getElementById('draftContent');
                if (draftContent) {
                    draftContent.innerHTML = '';
                }
            }
            document.getElementById('draftSection').style.display = 'none';
            document.getElementById('regenerateBtn').style.display = 'none';
            document.getElementById('replyInlineBtn').style.display = 'none';
            document.getElementById('sendEmailBtn').disabled = true;

            // Reset visibility of input sections and buttons
            document.getElementById('composeInputView').style.display = 'block';
            document.querySelector('.compose-tone-section').style.display = 'block';
            document.querySelector('.generate-btn').style.display = 'inline-flex';

            // Hide the Inline Reply mode
            document.getElementById('aiInlinModeSwitch').style.display = 'none';

            // Toggle off the AI Edit and Reply Inline
            document.getElementById('aiModeToggle').checked = false;
            document.getElementById('aiInlineModeToggle').checked = false;

            document.getElementById('toneSelector').value = 'professional'

            // Clean up editing state
            if (window.editingQueueItem) {
                delete window.editingQueueItem;
            }
        }

        function openMaximizeMode() {
            const modal = document.getElementById("composeModal");
            const icon = event.currentTarget;

            const isMaximized = modal.classList.toggle("maximized");

            if (isMaximized) {
                icon.classList.remove("fa-up-right-and-down-left-from-center");
                icon.classList.add("fa-down-left-and-up-right-to-center"); // hypothetical class
            } else {
                icon.classList.remove("fa-down-left-and-up-right-to-center");
                icon.classList.add("fa-up-right-and-down-left-from-center");
            }
        }

        let emailDraftData = {};

        function initializeEditor() {
            if (window.editorInstance) {
                return; // Already initialized
            }

            const draftContentElement = document.getElementById('draftContent');
            if (!draftContentElement) {
                console.error('Draft content element not found');
                return;
            }

            window.editorInstance = new FroalaEditor('#draftContent', {
                key: 'BWC6D-16E3F3E1F1C1A17A7wc2DBKSPJ1WKTUCQOd1OURPE1KDc1C-7J2A4D4A4C6E2G3F4G1D1==',
                toolbarButtons: [
                    'bold', 'italic', 'underline', '|',
                    'textColor', 'backgroundColor', 'fontFamily', 'fontSize', '|',
                    'formatOL', 'formatUL', 'outdent', 'indent', '|',
                    'alignLeft', 'alignCenter', 'alignRight', 'alignJustify',
                    'clearFormatting', '|',
                ],
                heightMin: 300,
                placeholderText: 'Your AI-generated draft will appear here...',
                toolbarSticky: false,
                toolbarStickyOffset: 0,
                pastePlain: false,
                pasteAllowedStyleProps: ['color', 'font-size', 'background-color', 'font-family', 'text-align'],
                pasteDeniedTags: ['style', 'script', 'iframe', 'object', 'embed', 'link', 'meta'],

                fontFamily: {
                    "Arial,Helvetica,sans-serif": 'Arial',
                    "Georgia,serif": 'Georgia',
                    "Impact,Charcoal,sans-serif": 'Impact',
                    "Tahoma,Geneva,sans-serif": 'Tahoma',
                    "'Times New Roman',Times,serif": 'Times New Roman',
                    "Verdana,Geneva,sans-serif": 'Verdana'
                },
                fontSize: ['8', '10', '12', '14', '18', '24', '36'],

                pluginsEnabled: ['fontFamily', 'fontSize', 'colors', 'lists', 'align', 'paragraphFormat', 'lineHeight', 'entities'],

                events: {
                    'contentChanged': function () {
                        clearTimeout(window.editorSyncTimeout);
                        window.editorSyncTimeout = setTimeout(() => {
                            if (!isAIEditor && emailDraftData && emailDraftData.draft) {
                                const htmlContent = window.editorInstance.html.get();
                                console.log(htmlContent, 'htmlContent-----------------------------------');
                                const textContent = htmlContent.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
                                emailDraftData.draft.body = textContent;

                                // Optional: Update send button state based on content
                                const sendBtn = document.getElementById('sendEmailBtn');
                                if (sendBtn) {
                                    sendBtn.disabled = !textContent.trim();
                                }
                            }
                        }, 500);
                    },
                    'blur': function () {
                        if (!isAIEditor && emailDraftData && emailDraftData.draft) {
                            const htmlContent = window.editorInstance.html.get();
                            const textContent = htmlContent.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
                            emailDraftData.draft.body = textContent;
                        }
                    },
                    // 'initialized': function () {
                    //     console.log('Froala Editor ready with enhanced toolbar!');
                    //     enableAIEditingFeatures();
                    // }
                }
            });
        }

        async function generateAIReply() {
            if (!selectedEmail) {
                alert('No email selected for reply.');
                return;
            }

            const tone = document.getElementById('toneSelector').value;
            const generateBtn = document.querySelector('.generate-btn');

            // Show loading state on button
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Reply...';
            generateBtn.disabled = true;

            // Show draft section with loading indicator
            const draftSection = document.getElementById('draftSection');
            draftSection.style.display = 'block';

            // Create and show loading overlay in draft content area
            const draftContent = document.getElementById('draftContent');
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'draft-loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="draft-loading-content">
                    <i class="fas fa-robot fa-2x" style="color: #c41e3a; margin-bottom: 16px;"></i>
                    <div class="loading-spinner"></div>
                    <p style="margin: 16px 0 0 0; color: #605e5c; font-size: 14px;">AI is generating your reply...</p>
                </div>
            `;
            draftContent.appendChild(loadingOverlay);

            // Auto-scroll to show the loading state
            setTimeout(() => {
                draftSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);

            try {
                const response = await fetch('/api/ai/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        originalEmail: {
                            subject: selectedEmail.subject,
                            sender: selectedEmail.sender,
                            body: selectedEmail.body || selectedEmail.clean_text,
                            clean_text: selectedEmail.clean_text,
                            analysis: selectedEmail.analysis
                        },
                        tone: tone
                    })
                });

                const data = await response.json();
                data.reply = JSON.parse(data.reply);

                if (data.success) {
                    // Create draft data structure
                    emailDraftData = {
                        draft: {
                            subject: `Re: ${selectedEmail.subject}`,
                            body: data.reply.body,
                            bodyHTML: data.reply.body.replace(/\n\n/g, '</p><p style="margin-bottom: 16px;">').replace(/\n/g, '<br>')
                        }
                    };

                    // Convert reply to HTML format
                    const htmlContent = data.reply.body
                        .split('\n\n')
                        .filter(para => para.trim())
                        .map(para => `<p style="margin-bottom: 16px;">${para.replace(/\n/g, '<br>')}</p>`)
                        .join('');

                    // Initialize editor if not already done
                    if (!window.editorInstance) {
                        initializeEditor();
                    }

                    if (window.editorInstance) {
                        window.editorInstance.html.set(htmlContent);
                    } else {
                        // Fallback: set content directly to textarea/div
                        const editorElement = document.getElementById('draftContent') || document.querySelector('.compose-draft-content');
                        if (editorElement) {
                            editorElement.innerHTML = htmlContent;
                        }
                    }

                    // Remove loading overlay
                    const loadingOverlay = document.querySelector('.draft-loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.remove();
                    }

                    document.getElementById('draftSection').style.display = 'block';
                    document.getElementById('regenerateBtn').style.display = 'inline-flex';
                    console.log(window.currentComposeType, 'window.currentComposeType-----------------------------------');

                    // Show Reply Inline button for reply type modals
                    if (window.currentComposeType === 'REPLY_WITH_AI') {
                        document.getElementById('replyInlineBtn').style.display = 'inline-flex';
                    }

                    document.getElementById('sendEmailBtn').disabled = false;

                    // Auto-scroll to the AI Generated Draft section after reply is generated
                    setTimeout(() => {
                        const draftSection = document.getElementById('draftSection');
                        if (draftSection) {
                            draftSection.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }, 200); // Small delay to ensure the content is fully rendered
                } else {
                    alert('Error generating reply: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating reply. Please try again.');
            } finally {
                // Remove loading overlay in case of error
                const loadingOverlay = document.querySelector('.draft-loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.remove();
                }

                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Draft';
                generateBtn.disabled = false;
            }
        }

        async function generateEmailDraft(type='') {
            const prompt = document.getElementById('composePrompt').value.trim();
            const tone = document.getElementById('toneSelector').value;

            if (!prompt) {
                alert('Please describe what you want to communicate.');
                return;
            }

            const generateBtn = document.querySelector('.generate-btn');
            if(type !== 'REGENERATE_EMAIL') generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            generateBtn.disabled = true;

            try {
                const response = await fetch('/api/ai/compose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        tone: tone
                    })
                });

                let data = await response.json();
                data.draft = JSON.parse(data.draft);
                emailDraftData = data;
                if (data.success) {
                    const draftContent = emailDraftData.draft.body;
                    window.editorInstance.html.set(draftContent.replace(/\n/g, '<br>'));

                    const htmlContent = draftContent
                        .split('\n\n')
                        .filter(para => para.trim())
                        .map(para => `<p style="margin-bottom: 16px;">${para.replace(/\n/g, '<br>')}</p>`)
                        .join('');

                    window.editorInstance.html.set(htmlContent);

                    generateBtn.style.display = 'none'
                    document.getElementById('draftSection').style.display = 'block';
                    document.getElementById('regenerateBtn').style.display = 'inline-flex';
                    document.getElementById('sendEmailBtn').disabled = false;

                    // Auto-scroll to the AI Generated Draft section after draft is generated
                    setTimeout(() => {
                        const draftSection = document.getElementById('draftSection');
                        if (draftSection) {
                            draftSection.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }, 200); // Small delay to ensure the content is fully rendered
                } else {
                    alert('Error generating draft: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating draft. Please try again.');
            } finally {
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Draft';
                generateBtn.disabled = false;
            }
        }

        function renderAIEditor(draftText) {
            const aiEditor = document.getElementById('aiDraftEditor');
            aiEditor.innerHTML = ''; // Clear previous content
            console.log('Okay is this....')

            const sentences = draftText.split('\n\n'); // Split by paragraphs
            sentences.forEach((paragraph, index) => {
                if (paragraph.trim() === '') return;

                const paraDiv = document.createElement('div');
                paraDiv.className = 'paragraph';

                const span = document.createElement('span');
                span.className = 'ai-sentence';
                span.setAttribute('data-id', index + 1);
                span.setAttribute('onclick', 'convertToSmartBox(this)');
                span.innerHTML = paragraph.replace(/\n/g, '<br>'); // preserve line breaks

                paraDiv.appendChild(span);
                aiEditor.appendChild(paraDiv);

                // Optional: Add "+" button to mimic addLine behavior
                const addLine = document.createElement('div');
                addLine.className = 'add-line-container';
                addLine.innerHTML = `<button class="add-line-btn" onclick="addNewLine(this)">+</button>`;
                aiEditor.appendChild(addLine);
            });
        }

        let isAIEditor = false;

        // function toggleEditorMode() {
        //     const aiEditor = document.getElementById('aiDraftEditor');
        //     const textEditor = document.getElementById('draftContent');
        //     const toggleBtn = document.getElementById('toggleEditorBtn');

        //     isAIEditor = !isAIEditor;

        //     if (isAIEditor) {
        //         textEditor.style.display = 'none';
        //         aiEditor.style.display = 'block';
        //         toggleBtn.innerText = 'Switch to Text Editor';
        //     } else {
        //         aiEditor.style.display = 'none';
        //         textEditor.style.display = 'block';
        //         toggleBtn.innerText = 'Switch to AI Editor';
        //         renderAIEditor(emailDraftData.draft.body);
        //     }
        // }

        function toggleEditorMode() {
            const aiEditor = document.getElementById('aiDraftEditor');
            const textEditor = document.getElementById('draftContent');
            const toggleBtn = document.getElementById('toggleEditorBtn');

            if (isAIEditor) {
                // Switching from AI to Text editor
                syncFromAIToText(); // Sync content first
                aiEditor.style.display = 'none';
                textEditor.style.display = 'block';
                toggleBtn.innerText = 'Switch to AI Editor';
                isAIEditor = false;
            } else {
                // Switching from Text to AI editor
                syncFromTextToAI(); // Sync content first
                textEditor.style.display = 'none';
                aiEditor.style.display = 'block';
                toggleBtn.innerText = 'Switch to Text Editor';
                isAIEditor = true;
            }
        }

        // Editor instance is now stored as window.editorInstance
        let aiModeEnabled = false; // AI mode is disabled by default
        let currentSelection = null;
        let aiEditPopup = null;
        let aiEventListenersAdded = false; // Track if event listeners are already added

        function handleTextSelectionInEditor() {
            if (!window.editorInstance || !aiModeEnabled) return;

            const selectedText = window.editorInstance.selection.text();

            if (selectedText && selectedText.trim().length > 0) {
                // Store current selection
                currentSelection = {
                    text: selectedText,
                    ranges: window.editorInstance.selection.ranges()
                };

                showAIEditPopup(selectedText);
            } else {
                hideAIEditPopup();
            }
        }

        function showAIEditPopup(selectedText) {
            if (!aiModeEnabled) return;

            const popup = createAIEditPopup();
            const selectedContent = document.getElementById('aiEditSelectedContent');

            // Update popup content
            selectedContent.textContent = selectedText.length > 100
                ? selectedText.substring(0, 100) + '...'
                : selectedText;

            // Position popup near the editor
            const editorElement = document.querySelector('#draftContent');
            const editorRect = editorElement.getBoundingClientRect();

            popup.style.left = (editorRect.right - 320) + 'px';
            popup.style.top = (editorRect.top + 100) + 'px';

            // Show popup
            popup.classList.add('active');

            // Reset preview state
            document.getElementById('aiEditPreview').style.display = 'none';
            document.getElementById('aiEditLoading').classList.remove('active');
        }

        function hideAIEditPopup() {
            if (aiEditPopup) {
                aiEditPopup.classList.remove('active');
            }
        }

        function createAIEditPopup() {
            if (aiEditPopup) return aiEditPopup;

            aiEditPopup = document.createElement('div');
            aiEditPopup.className = 'ai-edit-popup';
            aiEditPopup.innerHTML = `
        <div class="ai-edit-header">
            <div class="ai-edit-selected-text">Selected text:</div>
            <div class="ai-edit-selected-content" id="aiEditSelectedContent"></div>
        </div>
        <div class="ai-edit-options">
            <button class="ai-edit-btn" onclick="performAIEdit('formal')">
                <i class="fas fa-user-tie"></i> Make Formal
            </button>
            <button class="ai-edit-btn" onclick="performAIEdit('friendly')">
                <i class="fas fa-smile"></i> Make Friendly
            </button>
            <button class="ai-edit-btn" onclick="performAIEdit('shorter')">
                <i class="fas fa-compress-alt"></i> Shorten
            </button>
            <button class="ai-edit-btn" onclick="performAIEdit('longer')">
                <i class="fas fa-expand-alt"></i> Expand
            </button>
            <button class="ai-edit-btn" onclick="performAIEdit('simpler')">
                <i class="fas fa-lightbulb"></i> Simplify
            </button>
            <button class="ai-edit-btn primary" onclick="showCustomEdit()">
                <i class="fas fa-edit"></i> Custom
            </button>
        </div>
        <div class="ai-edit-loading" id="aiEditLoading">
            <i class="fas fa-spinner fa-spin"></i> Generating...
        </div>
        <div class="ai-edit-preview" id="aiEditPreview" style="display: none;">
            <div class="ai-edit-preview-label">AI Suggestion:</div>
            <div class="ai-edit-preview-text" id="aiEditPreviewText"></div>
            <div class="ai-edit-actions">
                <button class="ai-edit-accept" onclick="acceptAIEdit()">Accept</button>
                <button class="ai-edit-reject" onclick="rejectAIEdit()">Try Again</button>
                <button class="ai-edit-reject" onclick="hideAIEditPopup()">Cancel</button>
            </div>
        </div>
    `;

            document.body.appendChild(aiEditPopup);
            return aiEditPopup;
        }


        // Toggle AI Mode function
        let htmlData = null;
        function toggleAIMode(checkbox) {
            const aiInlineModeToggle = document.getElementById('aiInlineModeToggle')

            aiModeEnabled = checkbox.checked;
            if (aiModeEnabled) {
                if (aiInlineModeToggle.checked) {
                    aiInlineModeToggle.checked = false
                    toggleInlineAIMode(aiInlineModeToggle)
                }

                const viewer = document.querySelector("#draftContent > div.fr-wrapper > div")
                console.log(viewer, 'viewer-----------------------------------');

                emailDraftData.draft = viewer.innerHTML
                htmlData = convertEmailToHTML(emailDraftData.draft)
                document.querySelector("#draftContent > div.fr-wrapper > div").innerHTML = htmlData
            } else {
                const htmlElement = document.getElementById('emailEditor');

                const normalText = convertHTMLToEmail(htmlElement)
                emailDraftData.draft = normalText
                document.querySelector("#draftContent > div.fr-wrapper > div").innerHTML = normalText
            }
        }

        // function toggleInlineAIMode(checkbox) {
        //     const aiModeToggle = document.getElementById('aiModeToggle')

        //     aiModeEnabled = checkbox.checked;
        //     if (aiModeEnabled) {
        //         if (aiModeToggle.checked) {
        //             aiModeToggle.checked = false
        //             toggleInlineAIMode(aiModeToggle)
        //         }

        //         showInlineReply1()
        //     } else {
        //         const htmlElement = document.getElementById('emailEditor');

        //         const normalText = convertHTMLToEmail(htmlElement)
        //         emailDraftData.draft = normalText
        //         document.querySelector("#draftContent > div.fr-wrapper > div").innerText = normalText
        //     }
        // }

        function toggleInlineAIMode(checkbox) {
            const aiModeToggle = document.getElementById('aiModeToggle')

            aiModeEnabled = checkbox.checked;
            // if checkbox is enabled
            if (aiModeEnabled) {
                if (aiModeToggle.checked) {
                    aiModeToggle.checked = false
                    toggleInlineAIMode(aiModeToggle)
                }

                // showInlineReply1()  
                const viewer = document.querySelector("#draftContent > div.fr-wrapper > div")
                emailDraftData.draft = viewer.innerHTML
                htmlData = convertEmailToHTML1(emailDraftData.draft)
                document.querySelector("#draftContent > div.fr-wrapper > div").innerHTML = htmlData
            } else {
                const htmlElement = document.getElementById('emailEditor');

                const normalText = convertHTMLToEmail(htmlElement)
                emailDraftData.draft = normalText
                document.querySelector("#draftContent > div.fr-wrapper > div").innerHTML = normalText
            }
        }

        function enableAIEditingFeatures() {
            if (window.editorInstance && !aiEventListenersAdded) {
                window.editorInstance.events.on('mouseup', function () {
                    if (aiModeEnabled) {
                        setTimeout(() => handleTextSelectionInEditor(), 100);
                    }
                });

                window.editorInstance.events.on('keyup', function () {
                    if (aiModeEnabled) {
                        setTimeout(() => handleTextSelectionInEditor(), 100);
                    }
                });

                aiEventListenersAdded = true;
                console.log('AI event listeners added');
            }
        }

        function disableAIEditingFeatures() {
            hideAIEditPopup();
        }

        async function performAIEdit(style) {
            if (!currentSelection || !currentSelection.text) return;

            const loading = document.getElementById('aiEditLoading');
            const preview = document.getElementById('aiEditPreview');
            const previewText = document.getElementById('aiEditPreviewText');

            loading.classList.add('active');
            preview.style.display = 'none';

            try {
                const response = await fetch('/api/ai/rewrite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: currentSelection.text,
                        style: style
                    })
                });

                const data = await response.json();

                if (data.success) {
                    previewText.textContent = data.rewrittenText;
                    window.currentRewrittenText = data.rewrittenText;

                    loading.classList.remove('active');
                    preview.style.display = 'block';
                } else {
                    alert('Error rewriting text: ' + data.error);
                    loading.classList.remove('active');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error rewriting text. Please try again.');
                loading.classList.remove('active');
            }
        }

        function showCustomEdit() {
            const customInstruction = prompt('How would you like to rewrite this text?');
            if (customInstruction && customInstruction.trim()) {
                performAIEdit(customInstruction);
            }
        }

        function acceptAIEdit() {
            if (!window.currentRewrittenText || !currentSelection) return;

            window.editorInstance.selection.restore();
            window.editorInstance.html.insert(window.currentRewrittenText);

            hideAIEditPopup();

            currentSelection = null;
            window.currentRewrittenText = null;
        }

        function rejectAIEdit() {
            document.getElementById('aiEditPreview').style.display = 'none';
            window.currentRewrittenText = null;
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeEditor();

            document.addEventListener('click', function (event) {
                if (aiEditPopup && !aiEditPopup.contains(event.target) &&
                    !event.target.closest('.fr-element') &&
                    !event.target.closest('.fr-box')) {
                    hideAIEditPopup();
                }
            });
        });



        function syncFromTextToAI() {
            if (!window.editorInstance || !emailDraftData) return;

            const htmlContent = window.editorInstance.html.get();
            const textContent = htmlContent.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');

            emailDraftData.draft.body = textContent;

            renderAIEditor(textContent);
        }

        function syncFromAIToText() {
            if (!window.editorInstance) return;

            const aiEditor = document.getElementById('aiDraftEditor');
            const sentences = aiEditor.querySelectorAll('.ai-sentence');

            let combinedText = '';
            sentences.forEach((sentence, index) => {
                const text = sentence.textContent || sentence.innerText;
                combinedText += text;
                if (index < sentences.length - 1) {
                    combinedText += '\n\n';
                }
            });

            if (emailDraftData) {
                emailDraftData.draft.body = combinedText;
            }

            const htmlContent = combinedText.replace(/\n/g, '<br>');
            window.editorInstance.html.set(htmlContent);
        }

        // function getCurrentEditorContent() {
        //     if (isAIEditor) {
        //         const aiEditor = document.getElementById('aiDraftEditor');
        //         const sentences = aiEditor.querySelectorAll('.ai-sentence');
        //         let content = '';
        //         sentences.forEach((sentence, index) => {
        //             const text = sentence.textContent || sentence.innerText;
        //             content += text;
        //             if (index < sentences.length - 1) {
        //                 content += '\n\n';
        //             }
        //         });
        //         return content;
        //     } else {
        //         if (window.editorInstance) {
        //             const htmlContent = window.editorInstance.html.get();
        //             return htmlContent.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
        //         }
        //         return '';
        //     }
        // }

        function getCurrentEditorContent() {
            if (isAIEditor) {
                const htmlElement = document.getElementById('emailEditor');
                return convertHTMLToEmail(htmlElement)
            } else {
                return document.querySelector("#draftContent > div.fr-wrapper > div").innerHTML
            }
        }

        async function regenerateEmailDraft() {
            const aiModeToggle = document.getElementById('aiModeToggle')
            const aiInlineModeToggle = document.getElementById('aiInlineModeToggle')

            aiModeToggle.checked = false
            aiInlineModeToggle.checked = false

            aiModeToggle.disabled = true
            aiInlineModeToggle.disabled = true;

            const regenerateBtn = document.getElementById('regenerateBtn');
            const originalHTML = regenerateBtn.innerHTML;
            regenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Regenerating.....';
            regenerateBtn.disabled = true;

            const modalTitle = document.getElementById('composeModalTitle').textContent;
            if (modalTitle.includes('Reply with AI')) {
                await generateReplyInline('REGENERATE_EMAIL');
            } else {
                await generateEmailDraft('REGENERATE_EMAIL');
            }

            regenerateBtn.innerHTML = originalHTML
            regenerateBtn.disabled = false;

            aiModeToggle.disabled = false
            aiInlineModeToggle.disabled = false;
        }

        function saveToAIQueue() {
            const currentContent = getCurrentEditorContent();
            if (!currentContent.trim()) {
                alert('Please generate a draft first.');
                return;
            }
            console.log(currentContent, 'Send EMail:   currentContent------------------------');
            // TODO:
            // 1. Save the email to the AI Queue
            // 2. Update the queue item status to sent
            // 3. Update the queue item status to failed if the email saving fails
            alert('Email saved to AI Queue successfully!');
            closeComposeModal();
        }

        function scheduleEmail() {
            const draft = document.getElementById('draftContent').value;
            if (!draft.trim()) {
                alert('Please generate a draft first.');
                return;
            }

            // In a real application, this would open a scheduling dialog
            alert('Email scheduled successfully!');
            closeComposeModal();
        }

        // Close modal when clicking outside
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('composeModal');
            if (event.target === modal) {
                closeComposeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('composeModal');
                if (modal.classList.contains('active')) {
                    closeComposeModal();
                }
            }
        });

        let activeSmartBox = null;
        let hoverTimeout = null;

        function showReply() {
            const emailContent = document.getElementById('emailContent');

            // Remove any existing reply section to prevent duplicates
            const existingReplySection = emailContent.querySelector('.reply-section');
            if (existingReplySection) {
                existingReplySection.remove();
            }

            // Create the reply section
            const replySection = document.createElement('div');
            replySection.className = 'reply-section active';
            replySection.innerHTML = `
        <div class="reply-header">
            <div class="reply-title">
                <span>Reply</span>
                <span class="ai-badge">AI Draft</span>
            </div>
            <div class="reply-actions">
                <button class="action-btn" onclick="regenerateDraft()">
                    <span></span> New Draft
                </button>
                <button class="action-btn" onclick="closeDraft()">
                    <span></span> Cancel
                </button>
            </div>
        </div>
 
        <div class="email-editor editable-mode" id="emailEditor" contenteditable="true">
            <div class="paragraph">
                <span class="ai-sentence" data-id="1" onclick="convertToSmartBox(this)">Hi Tom,</span>
            </div>
           
            <div class="add-line-container">
                <button class="add-line-btn" onclick="addNewLine(this)">+</button>
            </div>
           
            <div class="paragraph">
                <span class="ai-sentence" data-id="2" onclick="convertToSmartBox(this)">Thanks for sending over the action items from our meeting.</span>
                <span class="ai-sentence" data-id="3" onclick="convertToSmartBox(this)">I've reviewed each item and here's my status update:</span>
            </div>
           
            <div class="add-line-container">
                <button class="add-line-btn" onclick="addNewLine(this)">+</button>
            </div>
           
            <div class="paragraph">
                <span class="ai-sentence" data-id="4" onclick="convertToSmartBox(this)">For the landing page update, I'll have the designs ready by Thursday EOD.</span>
                <span class="ai-sentence" data-id="5" onclick="convertToSmartBox(this)">I've already started implementing the new color palette and typography guidelines.</span>
            </div>
           
            <div class="add-line-container">
                <button class="add-line-btn" onclick="addNewLine(this)">+</button>
            </div>
           
            <div class="paragraph">
                <span class="ai-sentence" data-id="6" onclick="convertToSmartBox(this)">Regarding the mobile navigation bug, I met with Alex from the dev team this morning.</span>
                <span class="ai-sentence" data-id="7" onclick="convertToSmartBox(this)">We've identified the issue and expect to deploy a fix by tomorrow.</span>
            </div>
           
            <div class="add-line-container">
                <button class="add-line-btn" onclick="addNewLine(this)">+</button>
            </div>
           
            <div class="paragraph">
                <span class="ai-sentence" data-id="8" onclick="convertToSmartBox(this)">For the Q3 user feedback summary, I'll need access to the analytics dashboard.</span>
                <span class="ai-sentence" data-id="9" onclick="convertToSmartBox(this)">Once I have permissions, I can have the summary ready by Monday for your review.</span>
            </div>
           
            <div class="add-line-container">
                <button class="add-line-btn" onclick="addNewLine(this)">+</button>
            </div>
           
            <div class="paragraph">
                <span class="ai-sentence" data-id="10" onclick="convertToSmartBox(this)">I reviewed the onboarding flow mockups yesterday and left detailed feedback in Figma.</span>
                <span class="ai-sentence" data-id="11" onclick="convertToSmartBox(this)">Overall they look great, with just a few minor adjustments needed for accessibility.</span>
            </div>
           
            <div class="add-line-container">
                <button class="add-line-btn" onclick="addNewLine(this)">+</button>
            </div>
           
            <div class="paragraph">
                <span class="ai-sentence" data-id="12" onclick="convertToSmartBox(this)">I'll send out calendar invites for the stakeholder interviews today.</span>
                <span class="ai-sentence" data-id="13" onclick="convertToSmartBox(this)">Do you have a preferred order, or should I prioritize based on availability?</span>
            </div>
           
            <div class="add-line-container">
                <button class="add-line-btn" onclick="addNewLine(this)">+</button>
            </div>
           
            <div class="paragraph">
                <span class="ai-sentence" data-id="14" onclick="convertToSmartBox(this)">Let me know if you need any clarification on these items.</span>
            </div>
           
            <div class="add-line-container">
                <button class="add-line-btn" onclick="addNewLine(this)">+</button>
            </div>
           
            <div class="paragraph">
                <span class="ai-sentence" data-id="15" onclick="convertToSmartBox(this)">Best,<br>Sarah</span>
            </div>
        </div>
 
        <div class="send-section">
            <div class="tone-switchr">
                <span class="tone-chip active">Professional</span>
                <span class="tone-chip">Friendly</span>
                <span class="tone-chip">Concise</span>
            </div>
            <button class="send-btn" onclick="sendReply()">
                <i class="fa-solid fa-share"></i> Send Reply
            </button>
        </div>
    `;

            const emailBodyContainer = emailContent.querySelector('#email-content-header');
            if (emailBodyContainer) {
                emailBodyContainer.insertAdjacentElement('afterend', replySection);
            } else {
                emailContent.appendChild(replySection);
            }

            const editor = replySection.querySelector('#emailEditor');
            editor.addEventListener('input', handleEditorInput);
            editor.addEventListener('keydown', handleKeyDown);

            replySection.querySelectorAll('.tone-chip').forEach(chip => {
                chip.addEventListener('click', function () {
                    replySection.querySelectorAll('.tone-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            setTimeout(() => {
                replySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function convertEmailToHTML(emailHTML) {
            let dataId = 1;
            let htmlOutput = '<div class="email-editor editable-mode" id="emailEditor" contenteditable="true">\n';

            // Create a temporary div to parse the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = emailHTML;

            // Get all paragraph elements and list elements from Froala
            const froalaElements = tempDiv.querySelectorAll('p, div, ol, ul, li');

            if (froalaElements.length === 0) {
                // If no paragraphs, treat as single paragraph
                const content = tempDiv.innerHTML || emailHTML;
                htmlOutput += '    <div class="paragraph">\n';
                htmlOutput += `        <span class="ai-sentence" data-id="${dataId++}" onclick="convertToSmartBox(this)">${content}</span>\n`;
                htmlOutput += '    </div>\n';
                htmlOutput += '    <div class="add-line-container">\n';
                htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                htmlOutput += '    </div>\n';
            } else {
                // Process elements while preserving list structures
                let processedElements = new Set(); // Track processed elements to avoid duplicates

                froalaElements.forEach((element, index) => {
                    // Skip if this element was already processed as part of a list
                    if (processedElements.has(element)) return;

                    const tagName = element.tagName.toLowerCase();

                    if (tagName === 'ol' || tagName === 'ul') {
                        // Handle ordered and unordered lists
                        processedElements.add(element);
                        const listItems = element.querySelectorAll('li');

                        listItems.forEach(li => {
                            processedElements.add(li);
                            const liHTML = li.innerHTML;
                            htmlOutput += '    <div class="paragraph">\n';
                            htmlOutput += `        <span class="ai-sentence list-item" data-list-type="${tagName}" data-id="${dataId++}" onclick="convertToSmartBox(this)">${liHTML}</span>\n`;
                            htmlOutput += '    </div>\n';
                            htmlOutput += '    <div class="add-line-container">\n';
                            htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                            htmlOutput += '    </div>\n';
                        });
                    } else if (tagName === 'li' && !processedElements.has(element)) {
                        // Handle standalone list items (shouldn't normally happen, but just in case)
                        processedElements.add(element);
                        const liHTML = element.innerHTML;
                        const parentList = element.closest('ol, ul');
                        const listType = parentList ? parentList.tagName.toLowerCase() : 'ul';

                        htmlOutput += '    <div class="paragraph">\n';
                        htmlOutput += `        <span class="ai-sentence list-item" data-list-type="${listType}" data-id="${dataId++}" onclick="convertToSmartBox(this)">${liHTML}</span>\n`;
                        htmlOutput += '    </div>\n';
                        htmlOutput += '    <div class="add-line-container">\n';
                        htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                        htmlOutput += '    </div>\n';
                    } else if (tagName === 'p' || tagName === 'div') {
                        // Handle regular paragraphs and divs
                        processedElements.add(element);
                        const paraHTML = element.innerHTML;

                        // Check if this looks like a numbered list item (fallback for manually typed lists)
                        const isNumberedList = /^\d+\./.test(element.textContent.trim());

                        if (isNumberedList) {
                            // For numbered lists, keep as single sentence to preserve formatting
                            htmlOutput += '    <div class="paragraph">\n';
                            htmlOutput += `        <span class="ai-sentence list-item" data-list-type="ol" data-id="${dataId++}" onclick="convertToSmartBox(this)">${paraHTML}</span>\n`;
                            htmlOutput += '    </div>\n';
                        } else {
                            // For regular paragraphs, try to split by sentences while preserving formatting
                            const sentences = splitHTMLBySentences(paraHTML);
                            htmlOutput += '    <div class="paragraph">\n';
                            sentences.forEach(sentence => {
                                if (sentence.trim().length > 0) {
                                    htmlOutput += `        <span class="ai-sentence" data-id="${dataId++}" onclick="convertToSmartBox(this)">${sentence}</span>\n`;
                                }
                            });
                            htmlOutput += '    </div>\n';
                        }

                        htmlOutput += '    <div class="add-line-container">\n';
                        htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                        htmlOutput += '    </div>\n';
                    }
                });
            }

            htmlOutput += '</div>';
            return htmlOutput;
        }

        function splitHTMLBySentences(htmlContent) {
            const sentences = htmlContent.match(/[^.!?]+[.!?]+/g) || [htmlContent];
            return sentences.map(s => s.trim()).filter(s => s.length > 0);
        }

        function convertEmailToHTML1(emailContent) {
            let dataId = 1;
            let htmlOutput = '<div class="email-editor editable-mode" id="emailEditor" contenteditable="true">\n';

            // Check if input contains HTML tags (formatted content)
            const containsHTML = /<[^>]+>/.test(emailContent);

            if (containsHTML) {
                // Handle HTML content - preserve formatting
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = emailContent;

                // Get all paragraph-like elements and list elements
                const elements = tempDiv.querySelectorAll('p, div, br, ol, ul, li');

                if (elements.length === 0) {
                    // No block elements, treat as single paragraph
                    const content = tempDiv.innerHTML || emailContent;
                    htmlOutput += '    <div class="paragraph">\n';
                    htmlOutput += `        <span class="ai-sentence" data-id="${dataId++}" onclick="convertToSmartBox(this)">${content}</span>\n`;
                    htmlOutput += '    </div>\n';
                    htmlOutput += '    <div class="add-line-container">\n';
                    htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                    htmlOutput += '    </div>\n';
                } else {
                    // Process each paragraph element and list
                    const allElements = tempDiv.querySelectorAll('p, div, ol, ul, li');
                    const paragraphs = tempDiv.querySelectorAll('p, div');

                    if (paragraphs.length === 0 && allElements.length === 0) {
                        // Handle content with just <br> tags
                        const parts = tempDiv.innerHTML.split(/<br\s*\/?>/i);
                        parts.forEach((part, index) => {
                            const trimmed = part.trim();
                            if (trimmed.length > 0) {
                                // Check if it's a numbered list item
                                const isNumberedList = /^\d+\./.test(tempDiv.createElement('div').innerHTML = trimmed, tempDiv.textContent);

                                htmlOutput += '    <div class="paragraph">\n';
                                htmlOutput += `        <span class="ai-sentence" data-id="${dataId++}" onclick="convertToSmartBox(this)">${trimmed}</span>\n`;
                                htmlOutput += '    </div>\n';
                                htmlOutput += '    <div class="add-line-container">\n';
                                htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                                htmlOutput += '    </div>\n';
                            }
                        });
                    } else {
                        // Process elements while preserving list structures
                        let processedElements = new Set();

                        allElements.forEach((element, index) => {
                            if (processedElements.has(element)) return;

                            const tagName = element.tagName.toLowerCase();

                            if (tagName === 'ol' || tagName === 'ul') {
                                // Handle ordered and unordered lists
                                processedElements.add(element);
                                const listItems = element.querySelectorAll('li');

                                listItems.forEach(li => {
                                    processedElements.add(li);
                                    const liHTML = li.innerHTML;
                                    htmlOutput += '    <div class="paragraph">\n';
                                    htmlOutput += `        <span class="ai-sentence list-item" data-list-type="${tagName}" data-id="${dataId++}" onclick="convertToSmartBox(this)">${liHTML}</span>\n`;
                                    htmlOutput += '    </div>\n';
                                    htmlOutput += '    <div class="add-line-container">\n';
                                    htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                                    htmlOutput += '    </div>\n';
                                });
                            } else if (tagName === 'li' && !processedElements.has(element)) {
                                // Handle standalone list items
                                processedElements.add(element);
                                const liHTML = element.innerHTML;
                                const parentList = element.closest('ol, ul');
                                const listType = parentList ? parentList.tagName.toLowerCase() : 'ul';

                                htmlOutput += '    <div class="paragraph">\n';
                                htmlOutput += `        <span class="ai-sentence list-item" data-list-type="${listType}" data-id="${dataId++}" onclick="convertToSmartBox(this)">${liHTML}</span>\n`;
                                htmlOutput += '    </div>\n';
                                htmlOutput += '    <div class="add-line-container">\n';
                                htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                                htmlOutput += '    </div>\n';
                            } else if (tagName === 'p' || tagName === 'div') {
                                // Handle regular paragraphs and divs
                                processedElements.add(element);
                                const paraHTML = element.innerHTML;
                                const paraText = element.textContent.trim();

                                if (paraText.length === 0) return;

                                // Check if this is a numbered list item (fallback for manually typed lists)
                                const isNumberedList = /^\d+\./.test(paraText);

                                if (isNumberedList) {
                                    // For numbered lists, preserve as single sentence with formatting
                                    htmlOutput += '    <div class="paragraph">\n';
                                    htmlOutput += `        <span class="ai-sentence list-item" data-list-type="ol" data-id="${dataId++}" onclick="convertToSmartBox(this)">${paraHTML}</span>\n`;
                                    htmlOutput += '    </div>\n';
                                } else {
                                    // For regular paragraphs, keep entire paragraph as one sentence to preserve formatting
                                    htmlOutput += '    <div class="paragraph">\n';
                                    htmlOutput += `        <span class="ai-sentence" data-id="${dataId++}" onclick="convertToSmartBox(this)">${paraHTML}</span>\n`;
                                    htmlOutput += '    </div>\n';
                                }
                                htmlOutput += '    <div class="add-line-container">\n';
                                htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                                htmlOutput += '    </div>\n';
                            }
                        });
                    }
                }
            } else {
                // Handle plain text content (original logic)
                const paragraphs = emailContent.trim().split(/\n{2,}/);

                paragraphs.forEach((paragraph, index) => {
                    // Check if this is a list-type paragraph (contains numbered lines like 1., 2., 3.)
                    const lines = paragraph.split('\n').map(line => line.trim()).filter(line => line);
                    const isNumberedList = lines.length > 1 && lines.every(line => /^\d+\./.test(line));

                    if (isNumberedList) {
                        lines.forEach(line => {
                            htmlOutput += '    <div class="paragraph">\n';
                            const parts = line.match(/(\d+\.)|[^.!?]+[.!?]+|[^.!?]+$/g) || [line];
                            parts.forEach(part => {
                                const trimmed = part.trim();
                                if (trimmed.length > 0) {
                                    htmlOutput += `        <span class="ai-sentence" data-id="${dataId++}" onclick="convertToSmartBox(this)">${trimmed}</span>\n`;
                                }
                            });
                            htmlOutput += '    </div>\n';
                            htmlOutput += '    <div class="add-line-container">\n';
                            htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                            htmlOutput += '    </div>\n';
                        });
                    } else {
                        // For last paragraph: convert internal \n to <br>
                        if (index === paragraphs.length - 1) {
                            // Don't escape HTML if it's already formatted content
                            const withBr = paragraph.replace(/\n/g, '<br>');
                            htmlOutput += '    <div class="paragraph">\n';
                            htmlOutput += `        <span class="ai-sentence" data-id="${dataId++}" onclick="convertToSmartBox(this)">${withBr}</span>\n`;
                            htmlOutput += '    </div>\n';
                            htmlOutput += '    <div class="add-line-container">\n';
                            htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                            htmlOutput += '    </div>\n';
                        } else {
                            // Treat entire paragraph as one sentence/line (even if it has multiple sentences)
                            const trimmedParagraph = paragraph.trim();
                            if (trimmedParagraph.length > 0) {
                                htmlOutput += '    <div class="paragraph">\n';
                                htmlOutput += `        <span class="ai-sentence" data-id="${dataId++}" onclick="convertToSmartBox(this)">${trimmedParagraph}</span>\n`;
                                htmlOutput += '    </div>\n';
                                htmlOutput += '    <div class="add-line-container">\n';
                                htmlOutput += '        <button class="add-line-btn" onclick="addNewLine(this)">+</button>\n';
                                htmlOutput += '    </div>\n';
                            }
                        }
                    }
                });
            }

            htmlOutput += '</div>';
            return htmlOutput;
        }

        // function convertHTMLToEmail(htmlElement) {
        //     let emailText = '';
        //     const paragraphs = [...htmlElement.querySelectorAll('.paragraph')];

        //     for (let i = 0; i < paragraphs.length; i++) {
        //         const paragraph = paragraphs[i];
        //         const spans = [...paragraph.querySelectorAll('.ai-sentence')];
        //         let paragraphText = spans.map(span => span.textContent.trim()).join(' ');

        //         // Append paragraph text
        //         emailText += paragraphText;

        //         // Check if this and next paragraph are numbered list items (start with 1., 2., 3., etc.)
        //         const isCurrentListItem = /^\d+\./.test(paragraphText);
        //         const nextParagraph = paragraphs[i + 1];
        //         const isNextListItem = nextParagraph && /^\d+\./.test(nextParagraph.textContent.trim());

        //         if (isCurrentListItem && isNextListItem) {
        //             // Between consecutive numbered list items -> add single newline
        //             emailText += '\n';
        //         } else {
        //             // Else add two newlines to separate paragraphs
        //             emailText += '\n\n';
        //         }
        //     }

        //     // Trim extra trailing whitespace/newlines
        //     return emailText.trim();
        // }

        function convertHTMLToEmail(htmlElement) {
            const paragraphs = [...htmlElement.querySelectorAll('.paragraph')];
            console.log("Found paragraphs:", paragraphs.length);

            let emailHTML = '';
            let currentList = null;
            let currentListType = null;

            for (let i = 0; i < paragraphs.length; i++) {
                const paragraph = paragraphs[i];
                const spans = [...paragraph.querySelectorAll('.ai-sentence')];

                for (const span of spans) {
                    const spanHTML = span.innerHTML.trim();
                    const isListItem = span.classList.contains('list-item');
                    const listType = span.getAttribute('data-list-type');

                    if (isListItem && listType) {
                        // Handle list items
                        if (currentList === null || currentListType !== listType) {
                            // Close previous list if different type
                            if (currentList !== null) {
                                emailHTML += currentListType === 'ol' ? '</ol>' : '</ul>';
                            }
                            // Start new list
                            currentList = [];
                            currentListType = listType;
                            emailHTML += listType === 'ol' ? '<ol>' : '<ul>';
                        }
                        // Add list item
                        emailHTML += `<li>${spanHTML}</li>`;
                    } else {
                        // Handle regular content
                        if (currentList !== null) {
                            // Close any open list
                            emailHTML += currentListType === 'ol' ? '</ol>' : '</ul>';
                            currentList = null;
                            currentListType = null;
                        }

                        // Collect all non-list spans in this paragraph
                        let paragraphHTML = spans
                            .filter(s => !s.classList.contains('list-item'))
                            .map(s => s.innerHTML.trim())
                            .join(' ');

                        console.log(`Paragraph ${i + 1} HTML:`, paragraphHTML);

                        // Wrap in paragraph tag for Froala
                        if (paragraphHTML.trim()) {
                            emailHTML += `<p style="margin-bottom: 16px;">${paragraphHTML}</p>`;
                        }
                        break; // Move to next paragraph after processing all non-list spans
                    }
                }
            }

            // Close any remaining open list
            if (currentList !== null) {
                emailHTML += currentListType === 'ol' ? '</ol>' : '</ul>';
            }

            console.log("Final reconstructed email HTML:", emailHTML);
            return emailHTML;
        }

        function sendReply() {
            alert('Reply Sent Successfully!!');
            console.log('Reply Sent Successfully!!');
        }

        function closeDraft() {
            const replySection = document.querySelector('.reply-section');
            if (replySection) {
                replySection.remove();
            }
        }

        function convertToSmartBox(element) {
            if (hoverTimeout) {
                clearTimeout(hoverTimeout);
            }

            if (activeSmartBox && activeSmartBox !== element) {
                const existingId = activeSmartBox.dataset.sentenceId;
                convertBackToSentence(activeSmartBox, existingId);
            }

            if (element.classList.contains('smart-box-wrapper')) {
                return;
            }

            const sentenceId = element.dataset.id;
            const content = element.innerHTML;

            const wrapper = document.createElement('span');
            wrapper.className = 'smart-box-wrapper';
            wrapper.dataset.sentenceId = sentenceId;

            const smartBox = document.createElement('div');
            smartBox.className = 'smart-box';
            smartBox.innerHTML = `
        <span class="smart-box-label">AI Sentence</span>
        <div class="smart-box-content" contenteditable="true">${content}</div>
        <div class="smart-box-actions">
            <button class="micro-action" onclick="regenerateSentence(this, '${sentenceId}')"> Regen</button>
            <button class="micro-action" onclick="expandSentence(this)">+ Expand</button>
            <button class="micro-action" onclick="shortenSentence(this)"> Short</button>
            <button class="micro-action" onclick="deleteSentence(this)">X Delete</button>
        </div>
    `;

            wrapper.appendChild(smartBox);
            element.parentNode.replaceChild(wrapper, element);

            activeSmartBox = wrapper;

            const contentDiv = smartBox.querySelector('.smart-box-content');
            contentDiv.focus();

            wrapper.addEventListener('mouseleave', function (e) {
                const rect = wrapper.getBoundingClientRect();
                const isReallyLeaving = (
                    e.clientX < rect.left ||
                    e.clientX > rect.right ||
                    e.clientY < rect.top ||
                    e.clientY > rect.bottom
                );

                if (isReallyLeaving) {
                    hoverTimeout = setTimeout(() => {
                        if (activeSmartBox === wrapper && !wrapper.contains(document.activeElement) && wrapper.dataset.loading !== "true") {
                            convertBackToSentence(wrapper, sentenceId);
                        }
                    }, 300);
                }
            });

            wrapper.addEventListener('mouseenter', function () {
                if (hoverTimeout) {
                    clearTimeout(hoverTimeout);
                }
            });
        }

        function convertBackToSentence(wrapper, sentenceId) {
            const content = wrapper.querySelector('.smart-box-content').innerHTML;

            const sentence = document.createElement('span');
            sentence.className = 'ai-sentence';
            sentence.innerHTML = content;
            sentence.dataset.id = sentenceId;
            sentence.onclick = function () { convertToSmartBox(this); };

            wrapper.parentNode.replaceChild(sentence, wrapper);
            activeSmartBox = null;
        }

        // Helper function to extract context for AI generation
        function extractContext(button) {
            const smartBox = button.closest('.smart-box-wrapper');
            const currentSentence = smartBox.querySelector('.smart-box-content').textContent.trim();

            // Find the current paragraph
            const paragraph = smartBox.closest('.paragraph');
            let currentParagraph = '';
            let previousContext = '';

            if (paragraph) {
                // Get current paragraph text (excluding the smart box content)
                const paragraphClone = paragraph.cloneNode(true);
                const smartBoxes = paragraphClone.querySelectorAll('.smart-box-wrapper');
                smartBoxes.forEach(box => {
                    const originalText = box.dataset.sentenceId ?
                        box.querySelector('.smart-box-content').textContent : '';
                    const textNode = document.createTextNode(originalText);
                    box.parentNode.replaceChild(textNode, box);
                });
                currentParagraph = paragraphClone.textContent.trim();

                // Get previous paragraphs for context (up to 2 previous paragraphs)
                const allParagraphs = Array.from(document.querySelectorAll('.paragraph'));
                const currentIndex = allParagraphs.indexOf(paragraph);
                const previousParagraphs = allParagraphs.slice(Math.max(0, currentIndex - 2), currentIndex);

                previousContext = previousParagraphs.map(p => {
                    const clone = p.cloneNode(true);
                    const boxes = clone.querySelectorAll('.smart-box-wrapper');
                    boxes.forEach(box => {
                        const text = box.querySelector('.smart-box-content').textContent;
                        box.parentNode.replaceChild(document.createTextNode(text), box);
                    });
                    return clone.textContent.trim();
                }).join(' ');
            }

            // Extract email context if available
            const emailContext = {
                subject: window.currentEmailData?.subject || '',
                sender: window.currentEmailData?.sender || '',
                sentiment: window.currentEmailData?.analysis?.sentiment_category || ''
            };

            return {
                currentSentence,
                currentParagraph,
                previousContext,
                emailContext
            };
        }

        // Dynamic AI-powered sentence regeneration
        async function regenerateSentence(button, sentenceId) {
            const wrapper = button.closest('.smart-box-wrapper');
            wrapper.dataset.loading = "true";

            const content = button.closest('.smart-box').querySelector('.smart-box-content');
            const originalText = content.textContent.trim();

            const toneElement = document.getElementById('toneSelector');
            const tone = toneElement ? toneElement.value : 'professional';

            // Add loading state
            const originalContent = content.innerHTML;
            content.innerHTML = '<span class="ai-loading"><i class="fas fa-spinner fa-spin"></i> Generating...</span>';
            button.disabled = true;

            try {
                const context = extractContext(button);

                const response = await fetch('/api/ai/generate-sentence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'regenerate',
                        currentSentence: originalText,
                        previousContext: context.previousContext,
                        currentParagraph: context.currentParagraph,
                        tone: tone,
                        emailContext: context.emailContext
                    })
                });

                const result = await response.json();

                if (result.success) {
                    content.innerHTML = result.sentence;
                    content.style.animation = 'highlight 0.5s ease';
                    setTimeout(() => {
                        content.style.animation = '';
                    }, 500);
                } else {
                    throw new Error(result.error || 'Failed to generate sentence');
                }

            } catch (error) {
                console.error('Error regenerating sentence:', error);
                // Fallback to original content on error
                content.innerHTML = originalContent;

                // Show error briefly
                const errorSpan = document.createElement('span');
                errorSpan.textContent = ' (Error generating)';
                errorSpan.style.color = '#ff6b6b';
                errorSpan.style.fontSize = '0.8em';
                content.appendChild(errorSpan);

                setTimeout(() => {
                    if (errorSpan.parentNode) {
                        errorSpan.remove();
                    }
                }, 3000);
            } finally {
                button.disabled = false;
                wrapper.dataset.loading = "false";
            }
        }

        // Dynamic AI-powered sentence expansion
        async function expandSentence(button) {
            const wrapper = button.closest('.smart-box-wrapper');
            wrapper.dataset.loading = "true";

            const content = button.closest('.smart-box').querySelector('.smart-box-content');
            const originalText = content.textContent.trim();

            const toneElement = document.getElementById('toneSelector');
            const tone = toneElement ? toneElement.value : 'professional';

            // Add loading state
            const originalContent = content.innerHTML;
            content.innerHTML = '<span class="ai-loading"> <i class="fas fa-spinner fa-spin"></i> Expanding...</span>';
            button.disabled = true;

            try {
                const context = extractContext(button);

                const response = await fetch('/api/ai/generate-sentence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'expand',
                        currentSentence: originalText,
                        previousContext: context.previousContext,
                        currentParagraph: context.currentParagraph,
                        tone: tone,
                        emailContext: context.emailContext
                    })
                });

                const result = await response.json();

                if (result.success) {
                    content.innerHTML = result.sentence;
                    content.style.animation = 'highlight 0.5s ease';
                    setTimeout(() => {
                        content.style.animation = '';
                    }, 500);
                } else {
                    throw new Error(result.error || 'Failed to expand sentence');
                }

            } catch (error) {
                console.error('Error expanding sentence:', error);
                content.innerHTML = originalContent;

                const errorSpan = document.createElement('span');
                errorSpan.textContent = ' (Error expanding)';
                errorSpan.style.color = '#ff6b6b';
                errorSpan.style.fontSize = '0.8em';
                content.appendChild(errorSpan);

                setTimeout(() => {
                    if (errorSpan.parentNode) {
                        errorSpan.remove();
                    }
                }, 3000);
            } finally {
                button.disabled = false;
                wrapper.dataset.loading = "false";
            }
        }

        // Dynamic AI-powered sentence shortening
        async function shortenSentence(button) {
            const wrapper = button.closest('.smart-box-wrapper');
            wrapper.dataset.loading = "true";

            const content = button.closest('.smart-box').querySelector('.smart-box-content');
            const originalText = content.textContent.trim();

            const toneElement = document.getElementById('toneSelector');
            const tone = toneElement ? toneElement.value : 'professional';

            // Add loading state
            const originalContent = content.innerHTML;
            content.innerHTML = '<span class="ai-loading"> <i class="fas fa-spinner fa-spin"></i> Shortening...</span>';
            button.disabled = true;

            try {
                const context = extractContext(button);

                const response = await fetch('/api/ai/generate-sentence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'shorten',
                        currentSentence: originalText,
                        previousContext: context.previousContext,
                        currentParagraph: context.currentParagraph,
                        tone: tone,
                        emailContext: context.emailContext
                    })
                });

                const result = await response.json();

                if (result.success) {
                    content.innerHTML = result.sentence;
                    content.style.animation = 'highlight 0.5s ease';
                    setTimeout(() => {
                        content.style.animation = '';
                    }, 500);
                } else {
                    throw new Error(result.error || 'Failed to shorten sentence');
                }

            } catch (error) {
                console.error('Error shortening sentence:', error);
                content.innerHTML = originalContent;

                const errorSpan = document.createElement('span');
                errorSpan.textContent = ' (Error shortening)';
                errorSpan.style.color = '#ff6b6b';
                errorSpan.style.fontSize = '0.8em';
                content.appendChild(errorSpan);

                setTimeout(() => {
                    if (errorSpan.parentNode) {
                        errorSpan.remove();
                    }
                }, 3000);
            } finally {
                button.disabled = false;
                wrapper.dataset.loading = "false";
            }
        }

        function deleteSentence(button) {
            const wrapper = button.closest('.smart-box-wrapper');
            wrapper.remove();
            activeSmartBox = null;
        }

        function regenerateDraft() {
            const sentences = document.querySelectorAll('.ai-sentence');
            sentences.forEach(sentence => {
                const id = sentence.dataset.id;
                const alts = alternatives[id];
                if (alts) {
                    const currentText = sentence.innerHTML;
                    const newText = alts.find(alt => alt !== currentText) || alts[0];
                    sentence.innerHTML = newText;
                    sentence.style.animation = 'highlight 0.5s ease';
                    setTimeout(() => {
                        sentence.style.animation = '';
                    }, 500);
                }
            });
        }

        let nextDataId = 1000;

        function placeCaretAtEnd(el) {
            el.focus();
            if (typeof window.getSelection != "undefined" && typeof document.createRange != "undefined") {
                const range = document.createRange();
                range.selectNodeContents(el);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            } else if (typeof document.body.createTextRange != "undefined") {
                const textRange = document.body.createTextRange();
                textRange.moveToElementText(el);
                textRange.collapse(false);
                textRange.select();
            }
        }

        function addNewLine(button) {
            const container = button.closest('.add-line-container');
            const parent = container.parentNode;

            const newParagraph = document.createElement('div');
            newParagraph.className = 'paragraph';

            const newSpan = document.createElement('span');
            newSpan.className = 'ai-sentence';
            newSpan.setAttribute('data-id', nextDataId++);
            newSpan.setAttribute('contenteditable', 'true');
            newSpan.setAttribute('onclick', 'convertToSmartBox(this)');

            // Insert zero-width space initially so caret stays inside span
            newSpan.textContent = '\u200B';

            newParagraph.appendChild(newSpan);

            const newAddLineContainer = document.createElement('div');
            newAddLineContainer.className = 'add-line-container';
            newAddLineContainer.innerHTML = '<button class="add-line-btn" onclick="addNewLine(this)">+</button>';

            parent.insertBefore(newParagraph, container.nextSibling);
            parent.insertBefore(newAddLineContainer, newParagraph.nextSibling);

            placeCaretAtEnd(newSpan);
        }

        document.addEventListener('input', e => {
            if (e.target.classList && e.target.classList.contains('ai-sentence')) {
                // Remove zero-width spaces if user actually types content
                e.target.textContent = e.target.textContent.replace(/\u200B/g, '');
            }
        });


        function handleEditorInput(e) {
            if (window.processTimeout) {
                clearTimeout(window.processTimeout);
            }

            window.processTimeout = setTimeout(() => {
                processSentences();
            }, 1000);
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.execCommand('insertHTML', false, '</div><div class="add-line-container"><button class="add-line-btn" onclick="addNewLine(this)">+</button></div><div class="paragraph" contenteditable="true">');
            }
        }

        function processSentences() {
            const editor = document.getElementById('emailEditor');
            const paragraphs = editor.querySelectorAll('.paragraph');

            const selection = window.getSelection();
            const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
            const startOffset = range ? range.startOffset : 0;
            const startContainer = range ? range.startContainer : null;

            paragraphs.forEach(para => {
                if (para.querySelector('.smart-box-wrapper')) return;
                if (para === document.activeElement) return;
                if (startContainer && para.contains(startContainer)) return;

                const text = para.textContent.trim();
                if (!text || text.length < 5) return;
                if (para.querySelector('.ai-sentence')) return;

                const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
                if (sentences.length > 0) {
                    para.innerHTML = sentences.map((sentence, index) => {
                        const id = 'user-' + Date.now() + '-' + index;
                        return `<span class="ai-sentence" data-id="${id}" onclick="convertToSmartBox(this)">${sentence.trim()}</span>`;
                    }).join(' ');
                }
            });
        }

        /* AI Queue */
        let aiQueue = [];
        let aiQueueFilters = {
            status: 'all',
            type: 'all',
            priority: 'all'
        };
        let selectedQueueItems = new Set();

        async function addToAIQueue(item) {
            // Don't generate client-side ID - let the database handle it
            // Remove any client-generated ID to avoid conflicts
            if (item.id && typeof item.id === 'number' && item.id.toString().includes('.')) {
                delete item.id;
            }

            item.timestamp = item.timestamp || new Date().toISOString();
            item.status = item.status || 'ready';
            item.selected = false;

            const response = await fetch(API_BASE_URL + '/ai/queue/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(item),
                credentials: 'include'
            });

            const result = await response.json();

            // Map database fields to frontend fields
            const dbItem = result.item;
            let originalEmailData = null;
            if (dbItem.original_email) {
                try {
                    originalEmailData = JSON.parse(dbItem.original_email);
                } catch (error) {
                    console.error('Error parsing original_email JSON in addToAIQueue:', error, 'Raw data:', dbItem.original_email);
                    originalEmailData = null;
                }
            }
            const mappedItem = {
                id: dbItem.id,
                type: dbItem.type,
                subject: dbItem.subject,
                aiResponse: dbItem.content,
                content: dbItem.content,
                contentHtml: dbItem.content_html,
                originalPrompt: dbItem.prompt || '',
                tone: dbItem.tone,
                status: dbItem.status,
                timestamp: dbItem.timestamp || dbItem.updated_at,
                metadata: dbItem.metadata,
                selected: false,
                replyTo: originalEmailData?.to || '',
                originalEmail: originalEmailData
            };

            aiQueue.unshift(mappedItem);
            updateAIQueueCount();

            if (document.getElementById('ai-queueView').style.display !== 'none') {
                renderAIQueue();
            }

            console.log('Added to AI Queue:', item, 'Here is the result:', result);
        }

        function updateAIQueueCount() {
            const count = aiQueue.length;
            document.getElementById('aiQueueCount').textContent = count;
            if (document.getElementById('aiQueueTotal')) {
                document.getElementById('aiQueueTotal').textContent = count;
            }
        }

        function renderAIQueue() {
            const container = document.getElementById('aiQueueList');
            const filteredQueue = filterQueueItems();

            if (filteredQueue.length === 0) {
                container.innerHTML = `
            <div class="ai-queue-empty">
                <i class="fas fa-robot"></i>
                <h3>No AI-generated responses found</h3>
                <p>Use "Compose with AI" or "AI Reply" to create AI-assisted emails that will appear here for review.</p>
            </div>
        `;
                return;
            }

            container.innerHTML = '';

            filteredQueue.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'ai-queue-item';
                itemElement.innerHTML = `
            <div class="ai-queue-item-header">
                <div class="ai-queue-item-info">
                    <div class="ai-queue-item-subject">${item.subject || item.originalEmail?.subject || 'AI Generated Email'}</div>
                    <div class="ai-queue-item-from">
                        ${item.type === 'compose' ? 'New Email' : `Reply to: ${item.originalEmail?.to || 'Unknown'}`}
                    </div>
                    <div class="ai-queue-item-meta">
                        <span><i class="fas fa-clock"></i> ${new Date(item.timestamp).toLocaleString()}</span>
                        <span><i class="fas fa-tag"></i> ${item.type}</span>
                        <span class="ai-queue-status-badge ai-queue-status-${item.status}">
                            <i class="fas fa-circle"></i> ${item.status.replace('-', ' ')}
                        </span>
                        ${item.tone ? `<span><i class="fas fa-palette"></i> ${item.tone}</span>` : ''}
                    </div>
                </div>
                <div class="ai-queue-item-actions">
                    <input type="checkbox" onchange="toggleQueueItemSelection('${item.id}', this)" style="margin-right: 8px; accent-color: #c41e3a;">
                    ${aiQueueFilters.status !== 'sent' && item.status !== 'sent' ? `
                    <button class="ai-queue-action-btn ai-queue-send-btn" onclick="sendAIReply('${item.id}')">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                    <button class="ai-queue-action-btn ai-queue-edit-btn" onclick="editAIReply('${item.id}')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    ` : ''}
                    <button class="ai-queue-action-btn ai-queue-dismiss-btn" onclick="dismissAIReply('${item.id}')">
                        <i class="fas fa-times"></i> Dismiss
                    </button>
                </div>
            </div>
            ${renderAIReplyPreview(item)}
        `;
                container.appendChild(itemElement);
            });

            updateBulkActionsVisibility();
        }

        function renderAIReplyPreview(item) {
            if (item.type === 'inline-reply') {
                let html = '<div class="ai-queue-inline-replies">';
                if (item.aiResponse && Array.isArray(item.aiResponse)) {
                    item.aiResponse.forEach(response => {
                        html += `
                    <div class="ai-queue-inline-item">
                        <div class="ai-queue-inline-original">"${response.original}"</div>
                        <div class="ai-queue-inline-response">${response.response}</div>
                    </div>
                `;
                    });
                }
                html += '</div>';
                return html;
            } else {
                const content = item.aiResponse || item.content || 'No content available';
                const preview = content.length > 300 ? content.substring(0, 300) + '...' : content;
                return `<div class="ai-queue-reply-preview">${preview}</div>`;
            }
        }

        function filterQueueItems() {
            return aiQueue.filter(item => {
                if (aiQueueFilters.status !== 'all' && item.status !== aiQueueFilters.status) return false;
                if (aiQueueFilters.type !== 'all' && item.type !== aiQueueFilters.type) return false;
                if (aiQueueFilters.priority !== 'all') {
                    if (aiQueueFilters.priority === 'high-priority' && !item.highPriority) return false;
                    if (aiQueueFilters.priority === 'urgent' && !item.urgent) return false;
                }
                return true;
            });
        }

        function filterAIQueue(filterValue, element) {
            const filterRow = element.closest('.ai-queue-filter-row');
            const filterLabel = filterRow.querySelector('.ai-queue-filter-label').textContent.toLowerCase();

            filterRow.querySelectorAll('.ai-queue-filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            element.classList.add('active');

            if (filterLabel.includes('status')) {
                console.log(filterValue, 'filterValue---------------');

                aiQueueFilters.status = filterValue;
            } else if (filterLabel.includes('type')) {
                aiQueueFilters.type = filterValue;
            } else if (filterLabel.includes('priority')) {
                aiQueueFilters.priority = filterValue;
            }

            renderAIQueue();
            // Update bulk actions visibility to handle Send Selected button when filter changes
            updateBulkActionsVisibility();
        }


        function deleteAllAIQueue() {
            if (confirm('Are you sure you want to clear all items from the queue? \n\n This action cannot be undone.')) {
                showLoadingOverlay('Clearing AI Queue...', true);
                fetch(API_BASE_URL + '/ai/queue/clear-all', {
                    method: 'DELETE',
                    credentials: 'include'
                }).then(response => response.json()).then(data => {
                    if (data.success) {
                        alert('All items cleared from queue');
                        aiQueue = [];
                        renderAIQueue();
                    } else {
                        alert('Failed to clear all items from queue');
                    }
                }).finally(() => {
                    showLoadingOverlay('', false);
                });
            }
        }

        function showLoadingOverlay(message = '', showLoader = false) {
            if (showLoader) {
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'draft-loading-overlay';
                loadingOverlay.innerHTML = `
                <div class="draft-loading-content">
                    <i class="fas fa-robot fa-2x" style="color: #c41e3a; margin-bottom: 16px;"></i>
                    <div class="loading-spinner"></div>
                    <p style="margin: 16px 0 0 0; color: #605e5c; font-size: 14px;">${message}</p>
                </div>
            `;
                document.body.appendChild(loadingOverlay);
            } else {
                const loadingOverlay = document.querySelector('.draft-loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.remove();
                }
            }
        }

        function sendAIReply(itemId) {
            const item = aiQueue.find(i => i.id == itemId);
            showLoadingOverlay(item.type === 'compose' ? 'AI is sending your compose...' : 'AI is sending your reply...', true);
            if (item) {
                fetch(API_BASE_URL + '/ai/queue/send/' + itemId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                }).then(response => response.json()).then(data => {
                    if (data.success) {
                        alert(`Email "${item.subject || 'AI Generated Email'}" sent successfully!`);
                        loadAIQueue();
                    } else {
                        alert('Failed to send email');
                    }
                }).catch(error => {
                    console.error('Error sending email:', error);
                }).finally(() => {
                    showLoadingOverlay('', false);
                });
            }
        }

        function refreshEditorContent(updatedItem) {
            // Function to refresh editor content after API update
            try {
                const newContent = updatedItem.content || '';
                console.log('=== REFRESH EDITOR DEBUG ===');
                console.log('New content to display:', newContent);
                console.log('Updated item:', updatedItem);

                // Determine which editor mode is active
                const aiModeToggle = document.getElementById('aiModeToggle');
                const aiInlineModeToggle = document.getElementById('aiInlineModeToggle');
                const isAIMode = aiModeToggle && aiModeToggle.checked;
                const isAIInlineMode = aiInlineModeToggle && aiInlineModeToggle.checked;

                console.log('Editor modes - AI:', isAIMode, 'AI Inline:', isAIInlineMode);

                // Try to update all possible editors to ensure content is refreshed
                let updated = false;

                // Update AI inline editor if available
                const aiInlineEditor = document.getElementById('emailEditor');
                if (aiInlineEditor) {
                    console.log('Found AI inline editor, updating...');
                    try {
                        // Use the existing conversion function to maintain proper formatting
                        const htmlContent = convertEmailToHTML(newContent);

                        // Extract just the inner content (without the outer wrapper)
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        const emailEditorDiv = tempDiv.querySelector('.email-editor');

                        if (emailEditorDiv) {
                            const innerContent = emailEditorDiv.innerHTML;
                            aiInlineEditor.innerHTML = innerContent;
                            console.log(' AI inline editor updated successfully');
                            updated = true;
                        }
                    } catch (err) {
                        console.error('Error updating AI inline editor:', err);
                        // Fallback to simple update
                        aiInlineEditor.innerHTML = `<div class="paragraph" contenteditable="true">${newContent.replace(/\n\n/g, '</div><div class="paragraph" contenteditable="true">').replace(/\n/g, '<br>')}</div>`;
                        updated = true;
                    }
                }

                // Update Froala editor if available
                if (window.editorInstance) {
                    console.log('Found Froala editor instance, updating...');
                    try {
                        // Use convertEmailToHTML1 for Froala editor formatting
                        const htmlContent = convertEmailToHTML1(newContent);

                        // Extract content for Froala
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        const emailEditorDiv = tempDiv.querySelector('.email-editor');

                        if (emailEditorDiv) {
                            const innerContent = emailEditorDiv.innerHTML;

                            // More aggressive approach: destroy and recreate editor content
                            try {
                                // Save current editor state
                                const editorElement = window.editorInstance.$el[0];
                                const editorParent = editorElement.parentNode;

                                // Destroy current editor
                                window.editorInstance.destroy();

                                // Create new element with updated content
                                const newEditorElement = document.createElement('div');
                                newEditorElement.innerHTML = innerContent;
                                newEditorElement.id = 'draftContent';

                                // Replace in DOM
                                editorParent.replaceChild(newEditorElement, editorElement);

                                // Reinitialize Froala
                                window.editorInstance = new FroalaEditor('#draftContent', {
                                    heightMin: 300,
                                    placeholderText: 'Start typing your email...',
                                    toolbarButtons: ['bold', 'italic', 'underline', '|', 'paragraphFormat', 'align', '|', 'insertLink', 'insertTable', '|', 'undo', 'redo'],
                                    quickInsertButtons: ['table', 'ul', 'ol', 'hr'],
                                    charCounterCount: false
                                });

                                console.log(' Froala editor destroyed and recreated with new content');
                                updated = true;
                            } catch (destroyError) {
                                console.log('Editor destroy/recreate failed, using standard update:', destroyError);

                                // Fallback to standard update
                                window.editorInstance.html.set('');
                                window.editorInstance.html.set(innerContent);
                                window.editorInstance.events.trigger('contentChanged');

                                console.log(' Froala editor updated with standard method');
                                updated = true;
                            }

                            // Verify content was actually set
                            setTimeout(() => {
                                try {
                                    const currentContent = window.editorInstance.html.get();
                                    console.log('Verification - Current Froala content:', currentContent.substring(0, 100) + '...');
                                    console.log('Content contains updated text:', currentContent.includes('and it\'s not i guess') || currentContent.includes('Hoping to be good!'));
                                } catch (verifyError) {
                                    console.log('Content verification failed:', verifyError);
                                }
                            }, 200);
                        }
                    } catch (err) {
                        console.error('Error updating Froala editor:', err);
                        // Fallback to simple HTML
                        const simpleContent = newContent.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
                        window.editorInstance.html.set('');
                        window.editorInstance.html.set(`<p>${simpleContent}</p>`);
                        window.editorInstance.events.trigger('contentChanged');
                        updated = true;
                    }
                }

                // Update draft content element in Froala wrapper if available
                const froalaWrapper = document.querySelector("#draftContent > div.fr-wrapper > div");
                if (froalaWrapper) {
                    console.log('Found Froala wrapper, updating...');
                    try {
                        // For Froala, update the wrapper content
                        const htmlContent = convertEmailToHTML1(newContent);
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        const emailEditorDiv = tempDiv.querySelector('.email-editor');

                        if (emailEditorDiv) {
                            const innerContent = emailEditorDiv.innerHTML;

                            // Clear existing content first
                            froalaWrapper.innerHTML = '';

                            // Force reflow
                            froalaWrapper.offsetHeight;

                            // Set new content
                            froalaWrapper.innerHTML = innerContent;

                            console.log(' Froala wrapper updated successfully');
                            console.log('Wrapper content set to:', innerContent.substring(0, 100) + '...');
                            updated = true;
                        }
                    } catch (err) {
                        console.error('Error updating Froala wrapper:', err);
                        // Fallback to simple content
                        const simpleContent = newContent.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
                        froalaWrapper.innerHTML = '';
                        froalaWrapper.offsetHeight; // Force reflow
                        froalaWrapper.innerHTML = `<p>${simpleContent}</p>`;
                        updated = true;
                    }
                }

                // Fallback: Update draft content textarea if available
                const draftContentElement = document.getElementById('draftContent');
                if (draftContentElement && draftContentElement.tagName === 'TEXTAREA') {
                    draftContentElement.value = newContent;
                    console.log(' Draft textarea updated');
                    updated = true;
                }

                if (!updated) {
                    console.warn(' No editor found to update!');
                } else {
                    console.log(' Editor content refresh completed');
                }

            } catch (error) {
                console.error(' Critical error refreshing editor content:', error);
                // Emergency fallback
                const aiInlineEditor = document.getElementById('emailEditor');
                if (aiInlineEditor) {
                    aiInlineEditor.innerHTML = `<div class="paragraph" contenteditable="true">${(updatedItem.content || '').replace(/\n/g, '<br>')}</div>`;
                    console.log(' Emergency fallback applied');
                }
            }
        }

        function editAIReply(itemId) {
            console.log(itemId, 'AISA KI ITEM ID----->');
            const item = aiQueue.find(i => i.id == itemId);
            console.log(item, 'AISA KI ITEM----->');
            if (item) {
                console.log(item, 'ALIS KYA HAI SUNAAAA');

                // Defensive mapping: If item has original_email but not originalEmail, map it
                if (item.original_email && !item.originalEmail) {
                    console.log('Item has original_email but not originalEmail, mapping it now');
                    try {
                        item.originalEmail = item.original_email ? JSON.parse(item.original_email) : null;
                        console.log('Mapped originalEmail:', item.originalEmail);
                    } catch (error) {
                        console.error('Error parsing original_email JSON:', error, 'Raw data:', item.original_email);
                        item.originalEmail = null;
                    }
                }

                // Check if this is a compose item and handle it differently
                // if (item.type === 'compose') {
                //     console.log('Item is compose type, redirecting to editAICompose');
                //     editAICompose(item);
                //     return;
                // }

                // Determine the correct modal type based on the queue item type
                const modalType = item.type === 'compose' ? 'COMPOSE_WITH_AI' : 'REPLY_WITH_AI';
                const isEditingReply = item.type === 'reply';

                if (isEditingReply) {
                    // For replies, we need to display the email content FIRST so it can be cloned into the modal
                    console.log('Editing reply item:', item);
                    console.log('Original email data:', item.originalEmail);

                    if (!item.originalEmail) {
                        console.error('Original email data missing for reply item:', item);
                        console.error('Available properties:', Object.keys(item));
                        console.error('Item type:', item.type);
                        console.error('Item originalEmail value:', item.originalEmail);
                        console.error('Item replyTo value:', item.replyTo);

                        // Check if this is actually a compose item that was misclassified
                        if (item.type === 'compose') {
                            console.log('This is a compose item, not a reply. Switching to compose mode.');
                            editAICompose(item);
                            return;
                        }

                        alert('Error: Original email data is missing. Cannot edit this reply.\n\nThis might be due to data corruption or the item might be a compose email instead of a reply. Please check the browser console for more details.');
                        return;
                    }
                    item.originalEmail = typeof item.originalEmail === 'string' ? JSON.parse(item.originalEmail) : item.originalEmail;
                    if (!item.originalEmail.sender) {
                        console.error('Original email sender missing:', item.originalEmail);
                        // Try to provide a fallback
                        item.originalEmail.sender = 'unknown@example.com';
                    }

                    selectedEmail = item.originalEmail;
                    displayEmailDetail(item.originalEmail);

                    // Wait for email content to be displayed, then open modal
                    setTimeout(() => {
                        // Temporarily override the openComposeModal behavior for editing
                        const originalGenerateAIReply = window.generateAIReply;
                        window.generateAIReply = function () {
                            // Restore the original function
                            window.generateAIReply = originalGenerateAIReply;
                            // Don't generate, we're editing existing content
                            return Promise.resolve();
                        };

                        // Open the modal with the appropriate type to ensure consistent UI
                        openComposeModal(modalType);

                        // Continue with the rest of the setup
                        setupModalContent();
                    }, 100);
                } else {
                    // For compose, open modal immediately
                    openComposeModal(modalType);
                    setupModalContent();
                }

                function setupModalContent() {
                    // Set up the modal content based on item type
                    if (item.type === 'compose') {
                        document.getElementById('composePrompt').value = item.originalPrompt || 'Edit this AI-generated email';
                        document.getElementById('toneSelector').value = item.tone || 'professional';
                    } else {
                        // For replies, set up the context similar to Reply with AI
                        document.getElementById('toneSelector').value = item.tone || 'professional';

                        // For reply editing, we want to show the input section so users can see/modify the context
                        // This makes the Edit button behavior consistent with the AI buttons
                        setTimeout(() => {
                            const composeInputSection = document.getElementById('composeInputView');
                            if (composeInputSection) {
                                composeInputSection.style.display = 'block';
                                document.getElementById('composePrompt').value = `Edit reply to: ${item.originalEmail?.subject || 'Email'}`;
                            }
                        }, 50);
                    }

                    // Wait a moment for the modal to fully initialize, then set up the content
                    setTimeout(() => {
                        // Show the draft content and enable editing
                        const draftContent = item.aiResponse || item.content || '';

                        // Initialize editor if not already done
                        if (!window.editorInstance) {
                            initializeEditor();
                        }

                        // Set the draft content in the appropriate editor
                        if (window.editorInstance) {
                            // window.editorInstance.html.set(draftContent);
                            // window.editorInstance.html.set(draftContent.replace(/\n/g, '<br>'));
                            const htmlContent = draftContent
                                .split('\n\n')
                                .filter(para => para.trim())
                                .map(para => para.replace(/\n/g, '<br>'))
                                .join('');

                            window.editorInstance.html.set(htmlContent);
                        } else {
                            // Fallback: set content directly
                            const draftContentElement = document.getElementById('draftContent');
                            if (draftContentElement) {
                                if (draftContentElement.tagName === 'TEXTAREA') {
                                    draftContentElement.value = draftContent;
                                } else {
                                    draftContentElement.innerHTML = draftContent;
                                }
                            }
                        }

                        // Show the draft section and enable controls
                        document.getElementById('draftSection').style.display = 'block';
                        document.getElementById('regenerateBtn').style.display = 'inline-flex';

                        // Show Reply Inline button for reply type queue items
                        if (window.currentComposeType === 'REPLY_WITH_AI') {
                            document.getElementById('replyInlineBtn').style.display = 'inline-flex';
                        }

                        document.getElementById('sendEmailBtn').disabled = false;

                        // Hide the generate button since we already have content
                        const generateBtn = document.querySelector('.generate-btn');
                        if (generateBtn) {
                            generateBtn.style.display = 'none';
                        }

                        // Auto-scroll to the AI Generated Draft section for better UX
                        setTimeout(() => {
                            const draftSection = document.getElementById('draftSection');
                            if (draftSection) {
                                draftSection.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'start'
                                });
                            }
                        }, 100); // Small delay to ensure the section is fully rendered

                        // Mark this as an editing session
                        window.editingQueueItem = itemId;
                    }, isEditingReply ? 50 : 100); // Shorter delay for replies since modal is already set up
                }
            }
        }

        // Generate Reply Inline function
        async function generateReplyInline(type='') {
            const tone = document.getElementById('toneSelector').value || 'professional';
            const replyInlineBtn = document.getElementById('replyInlineBtn');

            // Show loading state
            const originalHTML = replyInlineBtn.innerHTML;
            if(type !== 'REGENERATE_EMAIL') replyInlineBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Inline Reply...';
            replyInlineBtn.disabled = true;

            try {
                // Get the current email data
                const originalEmail = window.currentEmailData;

                if (!originalEmail) {
                    throw new Error('No email data available for inline reply');
                }

                const response = await fetch('/api/ai/reply-inline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        originalEmail: originalEmail,
                        tone: tone
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to generate inline reply');
                }

                // Convert the inline reply to HTML format
                const inlineReply = data.reply;
                let htmlContent = '';

                // Add intro
                if (inlineReply.intro) {
                    htmlContent += `<div class="inline-reply-intro">${inlineReply.intro}</div>`;
                }

                // Add original email content with inline responses
                if (inlineReply.inlineResponses && inlineReply.inlineResponses.length > 0) {
                    inlineReply.inlineResponses.forEach(item => {
                        // Add original text in gray
                        htmlContent += `<div class="inline-reply-original">${item.originalText}</div>`;
                        // Add inline response
                        htmlContent += `<div class="inline-reply-response">${item.response}</div>`;
                    });
                }

                // Add closing
                if (inlineReply.closing) {
                    htmlContent += `<div class="inline-reply-closing">${inlineReply.closing}</div>`;
                }

                // Update the editor with the inline reply
                if (window.editorInstance) {
                    window.editorInstance.html.set(htmlContent);
                } else {
                    const draftContent = document.getElementById('draftContent');
                    if (draftContent) {
                        draftContent.innerHTML = htmlContent;
                    }
                }

                // Update the draft section title to indicate inline reply
                const draftHeader = document.querySelector('.compose-draft-header span');
                if (draftHeader) {
                    draftHeader.textContent = 'AI Inline Reply';
                }

                console.log('Inline reply generated successfully:', inlineReply);

                // Log the auto-detection results
                if (inlineReply.isInlineSuitable !== undefined) {
                    console.log('Auto-detection results:', {
                        suitable: inlineReply.isInlineSuitable,
                        features: inlineReply.detectedFeatures || []
                    });
                }

            } catch (error) {
                console.error('Error generating inline reply:', error);
                alert(`Error generating inline reply: ${error.message}`);
            } finally {
                // Restore button state
                replyInlineBtn.innerHTML = originalHTML;
                replyInlineBtn.disabled = false;
            }
        }

        // Dismis with API
        function dismissAIReply(itemId) {
            const item = aiQueue.find(item => item.id == itemId);
            showLoadingOverlay(item.type === 'compose' ? 'Dismissing AI Compose...' : 'Dismissing AI Reply...', true);
            if (item) {
                fetch(API_BASE_URL + '/ai/queue/' + itemId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Email dismissed successfully!');
                            loadAIQueue();
                        } else {
                            alert('Failed to dismiss email from AI Queue');
                        }
                    })
                    .catch(error => {
                        console.error('AI Queue Delete Error:', error);
                        alert('Failed to dismiss email from AI Queue');
                    })
                    .finally(() => {
                        showLoadingOverlay('', false);
                    });
            }
        }

        function toggleQueueItemSelection(itemId, checkbox) {
            if (checkbox.checked) {
                selectedQueueItems.add(itemId);
            } else {
                selectedQueueItems.delete(itemId);
            }
            updateBulkActionsVisibility();
        }

        function updateBulkActionsVisibility() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            const sendSelectedBtn = bulkActions.querySelector('.bulk-send-btn');

            if (selectedQueueItems.size > 0) {
                bulkActions.style.display = 'flex';
                selectedCount.textContent = selectedQueueItems.size;
                
                // Hide Send Selected button when "sent" filter is active
                if (sendSelectedBtn) {
                    sendSelectedBtn.style.display = aiQueueFilters.status === 'sent' ? 'none' : 'flex';
                }
            } else {
                bulkActions.style.display = 'none';
            }
        }

        function bulkSendSelected() {
            const selectedItems = Array.from(selectedQueueItems);
            if (selectedItems.length === 0) return;

            if (confirm(`Send ${selectedItems.length} selected emails?`)) {
                selectedItems.forEach(itemId => {
                    sendAIReply(itemId);
                });
                selectedQueueItems.clear();
                updateBulkActionsVisibility();
            }
        }

        function bulkDismissSelected() {
            const selectedItems = Array.from(selectedQueueItems);
            if (selectedItems.length === 0) return;

            if (confirm(`Dismiss ${selectedItems.length} selected items?`)) {
                selectedItems.forEach(itemId => {
                    dismissAIReply(itemId);
                });
            }
        }

        const originalShowView = window.showView;
        window.showView = function (viewName) {
            if (viewName === 'ai-queue') {
                document.querySelectorAll('.view').forEach(view => {
                    view.style.display = 'none';
                });

                document.getElementById('ai-queueView').style.display = 'block';

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });

                const aiQueueNav = document.querySelector('[onclick="showView(\'ai-queue\')"]');
                if (aiQueueNav) {
                    aiQueueNav.classList.add('active');
                }

                renderAIQueue();
            } else {
                if (originalShowView) {
                    originalShowView(viewName);
                } else {
                    document.querySelectorAll('.view').forEach(view => {
                        view.style.display = 'none';
                    });

                    const targetView = document.getElementById(viewName + 'View');
                    if (targetView) {
                        targetView.style.display = 'block';
                    }

                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });

                    const activeNav = document.querySelector(`[onclick="showView('${viewName}')"]`);
                    if (activeNav) {
                        activeNav.classList.add('active');
                    }
                }
            }
        };

        // Enhanced email send function to add to queue
        const originalSendEmail = window.saveToAIQueue;
        window.saveToAIQueue = function () {
            // const currentContent = getCurrentEditorContent();
            const aiModeToggle = document.getElementById('aiModeToggle')
            const aiInlineModeToggle = document.getElementById('aiInlineModeToggle')

            let contentHtml = '';
            let currentContent = ''
            if (aiInlineModeToggle.checked || aiModeToggle.checked) {
                const htmlElement = document.getElementById('emailEditor');
                contentHtml = htmlElement.innerHTML;
                currentContent = convertHTMLToEmail(htmlElement)
            } else {
                currentContent = getCurrentEditorContent()
                contentHtml = convertEmailToHTML1(currentContent)
            }

            const promptElement = document.getElementById('composePrompt');
            const toneElement = document.getElementById('toneSelector');
            const prompt = promptElement ? promptElement.value : '';
            const tone = toneElement ? toneElement.value : 'professional';

            if (!currentContent.trim()) {
                alert('Please generate a draft first.');
                return;
            }

            if (window.editingQueueItem) {
                const sendEmailBtn = document.querySelector('#sendEmailBtn');
                sendEmailBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                sendEmailBtn.disabled = true;

                // When editing an existing queue item, update it via API
                const item = aiQueue.find(item => item.id == window.editingQueueItem);
                if (item) {
                    console.log('Updating queue item:', window.editingQueueItem);

                    // Prepare update data
                    const updateData = {
                        id: window.editingQueueItem,
                        content: currentContent,
                        contentHtml: contentHtml,
                        tone: tone,
                        status: 'ready', // Mark as ready after editing
                        prompt: prompt,
                        lastEdited: new Date().toISOString()
                    };

                    // Get subject from the current draft if available
                    if (emailDraftData && emailDraftData.draft && emailDraftData.draft.subject) {
                        updateData.subject = emailDraftData.draft.subject;
                    }

                    // Add metadata with edit information
                    updateData.metadata = {
                        ...item.metadata,
                        lastEdited: new Date().toISOString(),
                        editedBy: 'user',
                        originalPrompt: prompt,
                        status: 'ready'
                    };

                    // Call the update API
                    fetch('/api/ai/queue/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    })
                        .then(response => response.json())
                        .then(data => {
                            sendEmailBtn.innerHTML = sendEmailBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                            sendEmailBtn.disabled = false;

                            if (data.success) {
                                console.log('Queue item updated successfully:', data.item);

                                // Update the local queue item with the response data
                                const updatedItem = data.item;
                                const queueIndex = aiQueue.findIndex(q => q.id == data.item.id);
                                if (queueIndex !== -1) {
                                    // Map database fields to frontend fields and merge
                                    aiQueue[queueIndex] = {
                                        ...aiQueue[queueIndex],
                                        // Database fields
                                        id: updatedItem.id,
                                        type: updatedItem.type,
                                        subject: updatedItem.subject,
                                        content: updatedItem.content,
                                        contentHtml: updatedItem.content_html, // Map database field
                                        tone: updatedItem.tone,
                                        status: updatedItem.status,
                                        timestamp: updatedItem.timestamp || updatedItem.updated_at,
                                        metadata: updatedItem.metadata,
                                        // Frontend compatibility fields
                                        aiResponse: updatedItem.content, // Maintain compatibility
                                        originalPrompt: updatedItem?.prompt || '',
                                        // Preserve original email data if it exists
                                        originalEmail: aiQueue[queueIndex].originalEmail,
                                        replyTo: aiQueue[queueIndex].replyTo,
                                        selected: aiQueue[queueIndex].selected || false
                                    };

                                    console.log('Updated queue item:', aiQueue[queueIndex]);
                                    console.log('Full aiQueue after update:', aiQueue);
                                } else {
                                    console.error('Could not find queue item with ID:', data.item.id);
                                }

                                renderAIQueue();

                                // Show success message
                                alert(`Email "${updatedItem.subject || 'AI Generated Email'}" saved successfully!`);

                                // Close current modal
                                closeComposeModal();

                                // Wait a moment then reopen with updated content
                                // setTimeout(() => {
                                //     // Find the updated item in the queue
                                //     const refreshedItem = aiQueue.find(item => item.id == data.item.id);
                                //     if (refreshedItem) {
                                //         console.log('Reopening modal with updated item:', refreshedItem);

                                //         // Store the editing item ID for the reopen
                                //         const editingItemId = window.editingQueueItem;

                                //         // Clear the editing state temporarily
                                //         delete window.editingQueueItem;

                                //         // Reopen the edit modal
                                //         editAIReply(data.item.id);
                                //     } else {
                                //         console.error('Could not find updated item to reopen');
                                //     }
                                // }, 500);
                            } else {
                                console.error('Failed to update queue item:', data.error);
                                alert(`Failed to update email: ${data.error}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error updating queue item:', error);
                            alert('Error updating email. Please try again.');
                        });
                }
                delete window.editingQueueItem;

                return;
            } else {
                // Determine if this is a reply or compose based on modal title and context
                const modalTitle = document.getElementById('composeModalTitle').textContent;
                const isReply = modalTitle.includes('Reply with AI');

                // Get the subject from the generated draft data if available
                let subject;
                if (isReply) {
                    subject = `Re: ${selectedEmail?.subject || 'Email'}`;
                } else {
                    // For compose, try to get subject from emailDraftData, fallback to default
                    subject = (emailDraftData && emailDraftData.draft && emailDraftData.draft.subject)
                        ? emailDraftData.draft.subject
                        : 'AI Generated Email';
                }

                const queueItem = {
                    type: isReply ? 'reply' : 'compose',
                    subject: subject,
                    aiResponse: currentContent,
                    content: currentContent,
                    contentHtml: contentHtml,
                    originalPrompt: prompt,
                    tone: tone,
                    status: 'review',
                    prompt: prompt
                };

                // If it's a reply, include the original email context
                if (isReply && selectedEmail) {
                    queueItem.originalEmail = selectedEmail;
                }

                addToAIQueue(queueItem);
            }

            alert('Email saved to AI Queue for review!');
            closeComposeModal();
        };

        // Function to load the AI Queue
        async function loadAIQueue() {
            showLoadingOverlay('Loading AI Queue...', true);
            aiQueue = [];
            updateAIQueueCount();

            const aiQueueRespose = await fetch(API_BASE_URL + '/ai/queue');
            const aiQueueResult = await aiQueueRespose.json();

            const modifiedQueue = aiQueueResult.queue.map(item => {
                let originalEmailData = null;
                if (item.original_email) {
                    try {
                        originalEmailData = JSON.parse(item.original_email);
                    } catch (error) {
                        console.error('Error parsing original_email JSON in loadAIQueue:', error, 'Raw data:', item.original_email);
                        originalEmailData = null;
                    }
                }
                const replyTo = originalEmailData?.to || '';
                const modifiedItem = {
                    id: item.id,
                    type: item.type,
                    subject: item.subject,
                    aiResponse: item.content,
                    content: item.content,
                    originalPrompt: item?.prompt,
                    tone: item.tone,
                    status: item.status,
                    timestamp: item.timestamp,
                    selected: false,
                    replyTo: replyTo.toString(),
                    originalEmail: originalEmailData
                }
                return modifiedItem
            })

            modifiedQueue.forEach(item => {
                aiQueue.push(item);
            });
            updateAIQueueCount();

            if (document.getElementById('ai-queueView').style.display !== 'none') {
                renderAIQueue();
            }
            showLoadingOverlay('', false);
        }

        // Load the AI Queue when the page loads
        document.addEventListener('DOMContentLoaded', async function () {
            loadAIQueue();
        });
    </script>
</body>

</html>